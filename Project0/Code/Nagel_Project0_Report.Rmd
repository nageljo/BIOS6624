---
title: "Evaluation of At-Home Sample Timing for Diurnal Hormone Level Characterization"
author: "Joe Nagel"
date: ""
output: pdf_document
fontsize: 12pt
mainfont: Helvetica
number_sections: true
geometry: margin=1in
header-includes:
  - \usepackage{setspace}
  - \doublespacing
  - \usepackage{float}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(list(echo = FALSE, include = FALSE))
```

```{r}
# read in packages
library(tidyverse)
library(naniar)
library(janitor)
library(lme4)
library(lmerTest)
library(emmeans)
library(gtsummary)
library(gt)
library(knitr)
library(kableExtra)
library(patchwork)
library(broom.mixed)
```

```{r}
# define outlier outcome values
HIGH_CORTISOL = 80
HIGH_DHEA = 5.205
```

```{r}
(
    # read in dataframe
    read_csv(
        '../Data/Project0_Clean_v2.csv',
        show_col_types = FALSE
    )
    
    # clean names
    %>% clean_names()
    
    # create time since wake columns
    %>% group_by(subject_id, collection_date)
    %>% arrange(collection_sample, .by_group = TRUE)
    %>% fill(sleep_diary_reported_wake_time, .direction = "down")
    %>% ungroup()
    %>% mutate(
        .after = sleep_diary_reported_wake_time,
        mems_time_since_wake =
            as.numeric(me_ms_clock_time - sleep_diary_reported_wake_time) / 3600,
        booklet_time_since_wake =
            as.numeric(booket_clock_time - sleep_diary_reported_wake_time) / 3600,
    )
    
    # create 15 and 30 min window indicator columns
    %>% mutate(
        mems_adherence_15 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(mems_time_since_wake - 30/60) <= 7.5/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(mems_time_since_wake - 10) <= 7.5/60, 1, 0)
        ),
        mems_adherence_30 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(mems_time_since_wake - 30/60) <= 15/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(mems_time_since_wake - 10) <= 15/60, 1, 0)
        ),
        booklet_adherence_15 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(booklet_time_since_wake - 30/60) <= 7.5/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(booklet_time_since_wake - 10) <= 7.5/60, 1, 0)
        ),
        booklet_adherence_30 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(booklet_time_since_wake - 30/60) <= 15/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(booklet_time_since_wake - 10) <= 15/60, 1, 0)
        )
    )
    # exclude extreme values and subject 3037
    %>% mutate(
        cortisol_nmol_l = case_when(
            cortisol_nmol_l >= HIGH_CORTISOL ~ NA_real_,
            subject_id == 3037 ~ NA_real_,
            .default = cortisol_nmol_l
        ),
        dhea_nmol_l = case_when(
            dhea_nmol_l >= HIGH_DHEA ~ NA_real_,
            subject_id == 3037 ~ NA_real_,
            .default = dhea_nmol_l
        ),
    )
) -> cort
```

```{r}
# Create table 1
# Select only the needed columns and convert Time to Hours
cort_long <- cort %>%
  select(
    collection_sample,
    booklet_time_since_wake,
    mems_time_since_wake,
    sleep_diary_reported_wake_time,
    cortisol_nmol_l,
    dhea_nmol_l
  ) %>%
  mutate(
    # Convert 'hms' sleep diary time to hours
    sleep_diary_reported_wake_time = as.numeric(sleep_diary_reported_wake_time) / 3600
  ) %>%
  # Pivot all variables of interest into a single long column
  pivot_longer(
    cols = -collection_sample,
    names_to = "Variable",
    values_to = "Value"
  ) 

# stack the data so we can calculate by collection sample and overall
data_ready <- bind_rows(
    cort_long %>% mutate(Group = as.character(collection_sample)),
    cort_long %>% mutate(Group = "Overall")
  ) %>%
  mutate(Group = recode(Group, 
    "1" = "Wake", "2" = "30-mins", "3" = "Lunch", "4" = "10-hours"
  )) %>%
  mutate(Group = factor(Group, levels = c("Overall", "Wake", "30-mins", "Lunch", "10-hours")))

# table of means and sd
tab_means_sds <- data_ready %>%
  group_by(Variable, Group) %>%
  summarise(
    Result = sprintf("%.2f (%.2f)", mean(Value, na.rm = TRUE), sd(Value, na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  mutate(Stat = "Mean (SD)")

# table of missings
tab_miss <- data_ready %>%
  group_by(Variable, Group) %>%
  summarise(
    Result = sprintf("%d (%.1f%%)", sum(is.na(Value)), mean(is.na(Value)) * 100),
    .groups = "drop"
  ) %>%
  mutate(Stat = "Missing n (%)")

# combine tables and format kable
summary_table <- bind_rows(tab_means_sds, tab_miss) %>%
  pivot_wider(names_from = Group, values_from = Result) %>%
  mutate(Variable = recode(Variable,
    "booklet_time_since_wake"        = "Booklet Time Since Wake (hrs)",
    "mems_time_since_wake"           = "MEMS Time Since Wake (hrs)",
    "sleep_diary_reported_wake_time" = "Sleep Diary Wake Time (hrs)",
    "cortisol_nmol_l"                = "Cortisol (nmol/L)",
    "dhea_nmol_l"                    = "DHEA (nmol/L)"
  )) %>%
  mutate(Variable = factor(Variable, levels = c(
    "Booklet Time Since Wake (hrs)",
    "MEMS Time Since Wake (hrs)",
    "Sleep Diary Wake Time (hrs)",
    "Cortisol (nmol/L)",
    "DHEA (nmol/L)"
  ))) %>%
  arrange(Variable, desc(Stat)) %>%
  select(Variable, Stat, Overall, Wake, `30-mins`, Lunch, `10-hours`) %>%
  kbl(caption = "Summary Statistics", align = "llccccc", booktabs = TRUE) %>%
  add_header_above(c(" " = 2, " " = 1, "Collection Sample" = 4), bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position")) %>%
  collapse_rows(columns = 1, valign = "middle")
```

```{r}
# model of timing method agreements
agreement_model = lmer(
    mems_time_since_wake ~ booklet_time_since_wake + (1 | subject_id),
    data = cort
)
```

```{r}
# Create table summarizing agreement model results 
# Extract coefficients, calculate custom tests, and rename terms
agreement_table <- tidy(agreement_model, effects = "fixed", conf.int = TRUE) %>%
  mutate(
    # Define the null hypothesis value (0 for Intercept, 1 for Slope)
    null_hypothesis = ifelse(term == "(Intercept)", 0, 1),
    
    # Recalculate t-statistic based on the specific null hypothesis
    statistic = (estimate - null_hypothesis) / std.error,
    
    # Recalculate p-value using df from the model summary
    df = summary(agreement_model)$coefficients[, "df"],
    p.value = 2 * (1 - pt(abs(statistic), df)),
    
    # rename terms
    term = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "booklet_time_since_wake" ~ "Slope",
      TRUE ~ term
    )
  ) %>%
  # Select and format columns for the final table
  mutate(
    .keep = "none",
    Term = term,
    Estimate = round(estimate, 3),
    `95% CI` = paste0("(", round(conf.low, 3), ", ", round(conf.high, 3), ")"),
    `Hypothesis` = paste0("beta = ", null_hypothesis),
    `t-value` = round(statistic, 2),
    `p-value` = format.pval(p.value, digits = 3, eps = 0.001)
  )

# convert to kable
agreement_table <- kable(agreement_table, caption = "Agreement Model Fixed Effects") %>%
    row_spec(0, bold = TRUE) 
```


```{r}
# scatter plot with fitted line for agreement method
# get betas from the model
betas <- fixef(agreement_model)

# create scatterplot of data with fitted and identity line
agreement_plot <- ggplot(data = cort, aes(x = booklet_time_since_wake, y = mems_time_since_wake)) +
  geom_point(alpha = 0.3, size = 2, shape = 1, na.rm = TRUE) + 
  geom_abline(aes(intercept = 0, slope = 1, 
                  color = "Perfect Agreement (y=x)", 
                  linetype = "Perfect Agreement (y=x)"), 
              linewidth = 0.8) +
  geom_abline(aes(intercept = betas[1], slope = betas[2], 
                  color = "Fitted Model", 
                  linetype = "Fitted Model"), 
              linewidth = 1.2) +
  scale_color_manual(name = NULL, 
                     values = c("Fitted Model" = "darkred", 
                                "Perfect Agreement (y=x)" = "grey50")) +
  scale_linetype_manual(name = NULL, 
                        values = c("Fitted Model" = "solid", 
                                   "Perfect Agreement (y=x)" = "dotted")) +
  coord_fixed() +
  labs(
    x = "Booklet Time Since Wake (Hours)",
    y = "MEMS Time Since Wake (Hours)"
  ) +
  theme_classic()
```

```{r, include=TRUE}
# table of adherence values
table_data <- cort %>%
  filter(collection_sample %in% c(2, 4)) %>%
  summarise(
    across(matches("adherence"), ~ mean(., na.rm = TRUE))
  ) %>%
  round(3) %>%
  pivot_longer(
    cols = everything(),
    names_to = c("recording_method", ".value"),
    names_pattern = "(.*)_(.*_.*)"
  )

adherence_table <- table_data %>%
  mutate(
    recording_method = recode(recording_method, 
                              "mems" = "MEMS Cap", 
                              "booklet" = "Booklet"),
    # Convert to percentages
    adherence_15 = scales::percent(adherence_15, accuracy = 0.1),
    adherence_30 = scales::percent(adherence_30, accuracy = 0.1)
  ) %>%
  rename(
    `Recording Method` = recording_method,
    `15-Minute Window` = adherence_15,
    `30-Minute Window` = adherence_30
  ) %>%
  kable(
    format = "latex", 
    booktabs = TRUE, 
    caption = "Adherence Rates by Recording Method",
    align = c("l", "c", "c"),
    escape = TRUE 
  ) %>%
  row_spec(0, bold = TRUE) %>%
  add_header_above(c(" " = 1, "Adherence Thresholds" = 2), bold = TRUE)
```


```{r}
# build cortisol model
cort_model <- lmer(
    log(cortisol_nmol_l) ~
        booklet_time_since_wake +
        pmax(0, booklet_time_since_wake - 0.5) +
        (1 | subject_id),
    data = cort
)
```

```{r}
# create plot of fitted regression line over the original data
pred_data <- data.frame(
  booklet_time_since_wake = seq(
    min(cort$booklet_time_since_wake, na.rm = TRUE), 
    max(cort$booklet_time_since_wake, na.rm = TRUE), 
    length.out = 200
  )
)

# get predicted values
pred_data$pred_log <- predict(cort_model, newdata = pred_data, re.form = NA)
pred_data$pred_cortisol <- exp(pred_data$pred_log)

# create plot
plot_cort_model <- (
    ggplot(cort, aes(x = booklet_time_since_wake, y = cortisol_nmol_l))
    + geom_point(alpha = 0.3, na.rm = TRUE)
    + geom_line(data = pred_data, aes(y = pred_cortisol), color = "darkred", linewidth = 2)
    + labs(
        x = "Booklet Time Since Wake (Hours)",
        y = "Cortisol (nmol/L)"
    )
    + theme_classic()
)
```


```{r}
# build DHEA model
dhea_model <- lmer(
    log(dhea_nmol_l) ~
        booklet_time_since_wake +
        pmax(0, booklet_time_since_wake - 0.5) +
        (1 | subject_id),
    data = cort
)
```

```{r}
# function to calculate relative changes for 30 mins and after
get_relative_change <- function(model, label) {
  
  # Calculate Slopes
  slope_early <- emtrends(model, ~1, var = "booklet_time_since_wake", 
                          at = list(booklet_time_since_wake = 0.1)) %>%
                 summary(infer = c(TRUE, TRUE)) %>% 
                 as.data.frame()
  
  slope_late <- emtrends(model, ~1, var = "booklet_time_since_wake", 
                         at = list(booklet_time_since_wake = 1.0)) %>%
                summary(infer = c(TRUE, TRUE)) %>% 
                as.data.frame()
  
  # Combine results
  res <- rbind(slope_early, slope_late)
  
  # Apply Transformations
  res <- res %>%
    mutate(
      period = c("0-30 min (total change)", "> 30 min (change/hour)"),
      time_multiplier = c(0.5, 1.0),
      
      # Relative Change %
      rel_change_pct = 100 * (exp(booklet_time_since_wake.trend * time_multiplier) - 1),
      
      # 95% CIs
      lower_ci = 100 * (exp(lower.CL * time_multiplier) - 1),
      upper_ci = 100 * (exp(upper.CL * time_multiplier) - 1),
      
      outcome = label
    ) %>%
    # Select columns
    select(outcome, period, rel_change_pct, lower_ci, upper_ci, p.value)
  
  return(res)
}
```


```{r}
# Create table of relative changes for DHEA and cortisol
table_cort <- get_relative_change(cort_model, "Cortisol")
table_dhea <- get_relative_change(dhea_model, "DHEA")

final_table <- rbind(table_cort, table_dhea) %>% 
    mutate(
        .keep = "none",
        Hormone = outcome,
        Period = period,
        `% Change` = rel_change_pct,
        `95% CI` = paste0("(", round(lower_ci, 2), ", ", round(upper_ci, 2), ")"),
        `p-value` = format.pval(p.value, digits = 3, eps = 0.001)
    )

# Convert to kable
hormone_models_table <- kable(final_table, digits = 2, caption = "Relative Changes in Cortisol and DHEA") %>% row_spec(0, bold = TRUE)
```

```{r}
# create plot of fitted regression line over the original data
pred_data <- data.frame(
  booklet_time_since_wake = seq(
    min(cort$booklet_time_since_wake, na.rm = TRUE), 
    max(cort$booklet_time_since_wake, na.rm = TRUE), 
    length.out = 200
  )
)
pred_data$pred_log <- predict(dhea_model, newdata = pred_data, re.form = NA)
pred_data$pred_dhea <- exp(pred_data$pred_log)

plot_dhea_model <- (
    ggplot(cort, aes(x = booklet_time_since_wake, y = dhea_nmol_l))
    + geom_point(alpha = 0.3, na.rm = TRUE)
    + geom_line(data = pred_data, aes(y = pred_dhea), color = "darkred", linewidth = 2)
    + labs(
        x = "Booklet Time Since Wake (Hours)",
        y = "DHEA (nmol/L)"
    )
    + theme_classic()
)
```

# Introduction

Cortisol and dehydroepiandrosterone (DHEA) are stress-regulating hormones that follow diurnal patterns, where disruptions often signal hormonal dysregulation. This report evaluates the Saliva Procurement and Integrated Testing (SPIT) booklet, a novel at-home filter paper method, by comparing its manual timing records to electronic Medication Event Monitoring System (MEMS) caps. The study analyzed 31 subjects who collected samples four times daily (waking, 30 minutes post-waking, before lunch, and 600 minutes post-waking) for three days. Primary goals included determining timing agreement between the booklet and MEMS caps, measuring study protocol adherence, and characterizing the diurnal profiles of these hormones. These goals were assessed with the following statistical hypotheses: (1) **Measurement Method Agreement**: Is there significant additive or proportional bias between the booklet and MEMS measuring cap sample times? (2) **Sample Timing Adherence**: What proportion of samples fell within $\pm 7.5$ minutes (good) and $\pm 15$ minutes (adequate) of the target times for the 30-min and 10-hour post-waking collections? (3) **Diurnal Hormone Patterns**: What is the change in hormone levels from waking to 30 minutes post waking? What is the change per hour in hormone levels after 30 minutes post waking?

# Methods

The key measures in the dataset (subject's sleep diary wake time, booklet sample time, MEMS cap sample time, cortisol (nmol/l), and DHEA (nmol/l)) were assessed for missingness and outliers. Outliers were defined as cortisol $\ge 80$ nmol/l and DHEA $\ge 5.205$ nmol/l (the assay upper detection limit for DHEA). Any samples exceeding these limits and all samples for subjects with multiple readings at the DHEA assay limit were excluded from the diurnal pattern analysis. Cortisol and DHEA were log transformed to reduce skewness and mitigate the violation of regression assumptions. The time between sleep diary waking time and sample collection was calculated for both the booklet and MEMS cap samples times. A table of descriptive statistics was created for the primary variables in the analysis. Prior to analysis for research question 3, outlier values of cortisol and DHEA were set to missing and one patient (subject 3037) was removed due to multiple DHEA readings at the assay limit.

All analysis were performed using a type one error rate ($\alpha$) of 0.05. All models and figures were created with R version 4.5.1. ChatGPT version 5.2 was used to debug code, outline the report, and copy-edit the report.

## Measurement Method Agreement

To address the agreement and bias between timing methods, we estimated the additive and proportional bias between the MEMS cap and booklet sample times. Additive bias represents a systematic difference in the reported times independent of time of day while proportional bias represents a relationship in the difference between the measurements that changes throughout the day. A linear mixed-effects model was fit with MEMS cap sample time since wake as the outcome and booklet sample time since wake as the predictor with a subject-specific random intercept to account for repeated measures. Additive bias was evaluated by testing whether the fixed effect intercept was different from 0 and proportional bias was evaluated by testing whether the fixed effect slope was different from 1. This relationship was also visualized.

## Sample Timing Adherence

To evaluate adherence to the study protocol's collection schedule, we assessed the proportion of samples that fell within $\pm 7.5$ minutes (good adherence) and $\pm 15$ minutes (adequate adherence) of the target collection time for the 30-minute and 10-hour post-waking collections. For each sample, we calculated the absolute difference between the observed collection time and the target collection time and created indicator variables for each of the adherence windows ($\pm 7.5$ and  $\pm 15$ minutes). The outcome was defined as the proportion of observed (nonmissing) samples that fell within the window. This was performed for both the booklet and MEMS cap times.

## Diurnal Hormone Patterns

To characterize diurnal patterns in cortisol and DHEA, we estimated changes over two intervals: waking to 30 minutes post waking and after 30 minutes post waking. The booklet sample time was used to define measurement time. This was decided based on the agreement and bias analysis as well as missingness. As described above, hormone concentrations were log transformed to reduce right skewness prior to modeling. Piecewise linear mixed-effects models were fit with time since waking as the predictor and hormone level as the outcome, including a subject-specific random intercept to account for repeated measures. Models included a single knot at 30 minutes (0.5 hours) to allow for distinct trends before and after the knot. The relative (multiplicative) change from waking to 30 minutes post waking and the relative change per hour after 30 minutes were estimated from the fitted models.


# Results

Data summary statistics and missingness are shown in **Table 1**. Notably, the  booklet provided more complete timing data (9.4% missing) compared to the MEMS cap system (16% missing). Sleep diary times were complete for all patients. Both hormone measurements had similar levels of missingness (~5% missing).

```{r, include=TRUE}
summary_table
```

## Measurement Method Agreement

The linear mixed-effect model comparing the booklet sample times to the MEMS cap sample times (**Table 2**) revealed significant additive bias between the measurements. The model's slope was not significantly different from 1 (p-value = 0.2) indicating no proportional bias between the measurement  methods. This indicates that the average time difference between the measurement methods did not change with the time of day. However, the intercept was significantly different from 0 (p-value < 0.001) indicating additive bias. At waking, MEMS cap sample times were on average 10.2 minutes (95% CI: 4.4, 15.9) minutes later than booklet sample times. The relationship is visualized in **Figure 1**. While the model showed slight additive bias between the measurements, the plot shows high agreement between the two methods, with the fitted and perfect agreement ($y=x$) lines almost completely overlapping.

```{r, include=TRUE}
agreement_table %>% kable_styling(latex_options = "HOLD_position")
```

```{r, include=TRUE, fig.align='center', fig.cap="Plot of Booklet vs MEMS Cap Times with LMM Fit", fig.pos="H"}
agreement_plot
```

## Sample Timing Adherence

Adherence to the study protocol varied by recording method (**Table 3**). For the good adherence threshold ($\pm 7.5$ minutes), only 41.8% of the MEMS cap samples were within the window, compared to 62.9% reported in the booklet. A similar pattern was observed for the adequate adherence threshold ($\pm 15$ minutes), where the booklet-reported adherence (73.7%) was substantially higher than the MEMS cap adherence (54.2%).

```{r, include=TRUE}
adherence_table %>% kable_styling(latex_options = "HOLD_position")
```

## Diurnal Hormone Patterns

For the analysis of diurnal hormone patters, the booklet time since waking was used as the predictor. While there was slight bias between measurements, the overall agreement between the MEMS cap and booklet times was high and the booklet times had less missingness. The parameters of interest estimated from the linear mixed-effects models of cortisol and DHEA are shown in **Table 4**. Both cortisol and DHEA were modeled on the log scale, so the resulting coefficients indicate relative (multiplicative) change in hormone level. There was, on average, a 20.2% (95% CI: -3.1, 49.1) relative increase in cortisol from waking to 30 minutes post waking; this increase was not significant (p-value = 0.093). After 30 minutes post waking, cortisol decreased by an average of 12.5% (95% CI: 10.6, 14.4) per hour, a significant decrease (p-value < 0.001). From waking to 30 minutes post waking, there was a significant average relative decrease in DHEA of 41.3% (p-value < 0.001; 95% CI: 29.7, 51.0). After 30 minutes post waking, there was an average relative decrease in DHEA of 8.8% (95% CI: 7.2, 10.5) per hour; this decrease was significant (p-value < 0.001). These relationships are visualized in **Figure 2** for both models. Note that the relationships are visualized on the original nmol/L scale.

```{r, include=TRUE}
hormone_models_table %>% kable_styling(latex_options = "HOLD_position")
```

```{r, include=TRUE, fig.cap="Fitted Diurnal Trajectories of Cortisol and DHEA"}
# combine the two plots into one pane
plot_cort_model + plot_dhea_model
```

# Discussion and Conclusions

The booklet proved effective for data completeness, with only 9.4% missing data compared to 16% for MEMS caps. However, a significant additive bias was observed; MEMS times were recorded 10.2 minutes later than booklet times, on average, suggesting participants recorded booklet times before opening the bottle. Additionally, booklet-reported adherence was roughly 20% higher than objective MEMS data, implying participants may have overestimated their compliance.

Cortisol followed the expected trajectory, though the initial rise was not statistically significant, possibly due to the small sample size ($n=31$). Conversely, DHEA unexpectedly decreased by 41.3% immediately post-waking, indicating a different awakening response than Cortisol. Limitations include the relatively small sample size and potential self-reporting errors in sleep diary wake times.

# Reproducible Research

Github Link: https://github.com/nageljo/BIOS6624

Data Path: `C:\Users\josep\OneDrive\AdvancedData\BIOS6624\Project0\Data\Project0_Clean_v2.csv`




