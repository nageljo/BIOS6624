---
title: "Project 0"
author: "Joseph Nagel"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
## read in packages
library(tidyverse)
library(naniar)
library(janitor)
library(lme4)
library(lmerTest)
```

```{r}
(
    ## read in dataframe
    read_csv(
        '../Data/Project0_Clean_v2.csv',
        show_col_types = FALSE
    )
    
    ## clean names
    %>% clean_names()
    
    ## create time since wake columns
    %>% group_by(subject_id, daynumb)
    %>% arrange(collection_sample, .by_group = TRUE)
    %>% fill(sleep_diary_reported_wake_time, .direction = "down")
    %>% ungroup()
    %>% mutate(
        .after = sleep_diary_reported_wake_time,
        mems_time_since_wake =
            as.numeric(me_ms_clock_time - sleep_diary_reported_wake_time) / 3600,
        booklet_time_since_wake =
            as.numeric(booket_clock_time - sleep_diary_reported_wake_time) / 3600,
    )
    
    ## create 15 and 30 min window indicator columns
    %>% mutate(
        mems_adherence_15 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(mems_time_since_wake - 30/60) <= 7.5/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(mems_time_since_wake - 10) <= 7.5/60, 1, 0)
        ),
        mems_adherence_30 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(mems_time_since_wake - 30/60) <= 15/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(mems_time_since_wake - 10) <= 15/60, 1, 0)
        ),
        booklet_adherence_15 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(booklet_time_since_wake - 30/60) <= 7.5/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(booklet_time_since_wake - 10) <= 7.5/60, 1, 0)
        ),
        booklet_adherence_30 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(booklet_time_since_wake - 30/60) <= 15/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(booklet_time_since_wake - 10) <= 15/60, 1, 0)
        )
    )
) -> cort
```

```{r}
## check for cortisol_nmol_l outliers ----- THIS GOES IN QUESTION 3 MODELING: mention in methods that we checked for bad values
cort %>% filter(cortisol_nmol_l >= 80)
```

```{r}
## check for dhea_nmol_l outliers ----- THIS GOES IN QUESTION 3 MODELING: mention in methods that we checked for bad values
cort %>% filter(dhea_nmol_l >= 5.205)
```

```{r}
## check id 3037
cort %>% filter(subject_id == 3037)
```


```{r}
## check missingness
# vis_miss(cort)
```

```{r}
## per column missingness
(
    cort
    %>% select(c(booket_clock_time, me_ms_clock_time, sleep_diary_reported_wake_time, cortisol_nmol_l, dhea_nmol_l))
    %>% summarise(
        across(
            everything(),
            ~mean(is.na(.))
        )
    )
    %>% round(2)
)
```


```{r}
## plot for Q1
(
    ggplot(data = cort, aes(x = booklet_time_since_wake, y = mems_time_since_wake))
    + geom_abline(intercept = 0, slope = 1)
    + geom_point(alpha = 0.2, size = 3)
    + labs(
        x = "Booklet Time Since Wake (Hours)",
        y = "MEMs Time Since Wake (Hours)"
    )
    + theme_classic()
)
```

```{r}
## model for Q1
agreement_model <- lmer(
    mems_time_since_wake - booklet_time_since_wake ~ booklet_time_since_wake + (1 | subject_id),
    data = cort
)
summary(agreement_model)
fixef(agreement_model, parm = "beta_")
confint(agreement_model, parm = "beta_")
```

```{r}
## test if slope is different from 1
## H0: slope = 1
contest(agreement_model, L = c(0, 1), rhs = 1)
```


```{r}
## table for Q2
(
    cort
    %>% filter(collection_sample %in% c(2, 4))
    # %>% filter(across(matches("adherence"), ~!is.na(.)))
    %>% summarise(
        across(
            matches("adherence"),
            ~mean(., na.rm = TRUE)
        )
    )
    %>% round(2)
    %>% pivot_longer(
        cols = everything(),
        names_to = c("recording_device", ".value"),
        names_pattern = c("(.*)_(.*_.*)")
    )
)
```

```{r}
(
    ggplot(data = cort %>% filter(mems_time_since_wake >= 0.5), aes(x = mems_time_since_wake, y = log1p(dhea_nmol_l + 1)))
    + geom_point()
)
```

```{r}
hist(as.numeric(cort$sleep_diary_reported_wake_time)/3600)
```






