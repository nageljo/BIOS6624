---
title: "Project 0"
author: "Joseph Nagel"
date: "`r Sys.Date()`"
output: pdf_document
fontsize: 12pt
mainfont: Helvetica
header-includes:
  - \usepackage{setspace}
  - \doublespacing
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(list(echo = FALSE, include = FALSE))
```

```{r}
## read in packages
library(tidyverse)
library(naniar)
library(janitor)
library(lme4)
library(lmerTest)
library(emmeans)
```

```{r}
## define outlier outcome values
HIGH_CORTISOL = 80
HIGH_DHEA = 5.205
```


```{r}
(
    ## read in dataframe
    read_csv(
        '../Data/Project0_Clean_v2.csv',
        show_col_types = FALSE
    )
    
    ## clean names
    %>% clean_names()
    
    ## create time since wake columns
    %>% group_by(subject_id, collection_date)
    %>% arrange(collection_sample, .by_group = TRUE)
    %>% fill(sleep_diary_reported_wake_time, .direction = "down")
    %>% ungroup()
    %>% mutate(
        .after = sleep_diary_reported_wake_time,
        mems_time_since_wake =
            as.numeric(me_ms_clock_time - sleep_diary_reported_wake_time) / 3600,
        booklet_time_since_wake =
            as.numeric(booket_clock_time - sleep_diary_reported_wake_time) / 3600,
    )
    
    ## create 15 and 30 min window indicator columns
    %>% mutate(
        mems_adherence_15 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(mems_time_since_wake - 30/60) <= 7.5/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(mems_time_since_wake - 10) <= 7.5/60, 1, 0)
        ),
        mems_adherence_30 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(mems_time_since_wake - 30/60) <= 15/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(mems_time_since_wake - 10) <= 15/60, 1, 0)
        ),
        booklet_adherence_15 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(booklet_time_since_wake - 30/60) <= 7.5/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(booklet_time_since_wake - 10) <= 7.5/60, 1, 0)
        ),
        booklet_adherence_30 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(booklet_time_since_wake - 30/60) <= 15/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(booklet_time_since_wake - 10) <= 15/60, 1, 0)
        )
    )
) -> cort
```

```{r}
## check for cortisol_nmol_l outliers ----- THIS GOES IN QUESTION 3 MODELING: mention in methods that we checked for bad values
cort %>% filter(cortisol_nmol_l >= 80)
```

```{r}
## check for dhea_nmol_l outliers ----- THIS GOES IN QUESTION 3 MODELING: mention in methods that we checked for bad values
cort %>% filter(dhea_nmol_l >= 5.205)
```

```{r}
## check id 3037
cort %>% filter(subject_id == 3037)
```


```{r}
## check missingness
# vis_miss(cort)
```

```{r}
## per column missingness
(
    cort
    %>% select(c(booket_clock_time, me_ms_clock_time, sleep_diary_reported_wake_time, cortisol_nmol_l, dhea_nmol_l))
    %>% summarise(
        across(
            everything(),
            ~mean(is.na(.))
        )
    )
    %>% round(2)
)
```


think about proportional bias and additive bias

```{r}
## model for Q1

agreement_model_prop = lmer(
    mems_time_since_wake ~ booklet_time_since_wake + (1 | subject_id),
    data = cort
)
agreement_model_add = lmer(
    mems_time_since_wake - booklet_time_since_wake ~ (1 | subject_id),
    data = cort
)
summary(agreement_model_prop)
fixef(agreement_model_prop, parm = "beta_")
confint(agreement_model_prop, parm = "beta_")
```

```{r}
## plot for Q1
(
    ggplot(data = cort, aes(x = booklet_time_since_wake, y = mems_time_since_wake))
    + geom_abline(intercept = 0, slope = 1)
    + geom_point(alpha = 0.2, size = 3, na.rm = TRUE)
    + labs(
        x = "Booklet Time Since Wake (Hours)",
        y = "MEMs Time Since Wake (Hours)"
    )
    + theme_classic()
)
```

```{r}
## test if slope is different from 1
## H0: slope = 1
contest(agreement_model_prop, L = c(0, 1), rhs = 1)
```



```{r}
## table for Q2
(
    cort
    %>% filter(collection_sample %in% c(2, 4))
    # %>% filter(across(matches("adherence"), ~!is.na(.)))
    %>% summarise(
        across(
            matches("adherence"),
            ~mean(., na.rm = TRUE)
        )
    )
    %>% round(3)
    %>% pivot_longer(
        cols = everything(),
        names_to = c("recording_method", ".value"),
        names_pattern = c("(.*)_(.*_.*)")
    )
)
```

```{r}
(
    cort
    %>% select(subject_id, collection_date, daynumb)
    %>% summarise(
        .by = subject_id,
        n_dates = n_distinct(collection_date),
        n_daynumbs = n_distinct(daynumb),
    )
)
```


```{r}
(
    ggplot(data = cort %>% filter(mems_time_since_wake >= 0.5), aes(x = mems_time_since_wake, y = log1p(dhea_nmol_l + 1)))
    + geom_point()
)
```

```{r}
hist(as.numeric(cort$sleep_diary_reported_wake_time) / 3600)
```

```{r}
anomalous_dhea_subjects <- (
    cort
    %>% summarise(
        .by = subject_id,
        n_limit_dhea = sum(dhea_nmol_l >= HIGH_DHEA, na.rm = TRUE)
    )
    %>% filter(n_limit_dhea > 1)
)
anomalous_dhea_subjects
```

```{r}
## cortisol model
(
    cort
    ## exclusion criteria
    %>% filter(!(subject_id %in% select(anomalous_dhea_subjects, subject_id)))
    %>% filter(cortisol_nmol_l <= HIGH_CORTISOL)
    
    ## create col for mems > 0.5
    %>% mutate(mems_time_since_wake_30_min = pmax(0, mems_time_since_wake - 0.5))
) -> q3_cort_data
    
    ## build model
cort_model <- lmer(
    log1p(cortisol_nmol_l) ~ mems_time_since_wake + mems_time_since_wake_30_min + (1 | subject_id),
    data = q3_cort_data
)
summary(cort_model)
```

```{r}

# Create a smooth grid of time values for a clean fitted line
grid <- tibble(
  mems_time_since_wake = seq(
    min(q3_cort_data$mems_time_since_wake, na.rm = TRUE),
    max(q3_cort_data$mems_time_since_wake, na.rm = TRUE),
    length.out = 200
  )
) %>%
  mutate(
    mems_time_since_wake_30_min = pmax(0, mems_time_since_wake - 0.5)
  )

# Predict from fixed effects only, then back-transform to nmol/L
grid <- grid %>%
  mutate(
    fit_log = predict(cort_model, newdata = grid, re.form = NA),
    # fit_nmol = expm1(fit_log)
  )

# Plot raw points + fitted line (original scale)
ggplot(q3_cort_data, aes(x = mems_time_since_wake, y = log1p(cortisol_nmol_l))) +
  geom_point(alpha = 0.35, size = 1, na.rm = TRUE) +
  geom_line(data = grid, aes(x = mems_time_since_wake, y = fit_log),
            color = "#1f77b4", linewidth = 1.1) +
  labs(
    title = "Cortisol vs Time Since Wake",
    subtitle = "Points = observed cortisol (nmol/L); line = fitted (fixed effects; back-transformed)",
    x = "Time since wake (hours)",
    y = "log(Cortisol + 1)"
  ) +
  theme_minimal()
```


```{r}
## define dhea analysis dataset
(
    cort
    ## exclusion criteria
    %>% filter(!(subject_id %in% select(anomalous_dhea_subjects, subject_id)))
    %>% filter(dhea_nmol_l < HIGH_DHEA)
    
    ## create col for mems > 0.5
    %>% mutate(
        mems_time_since_wake_30_min = pmax(0, mems_time_since_wake - 0.5)
    )
) -> q3_dhea_data

## build model
dhea_model <- lmer(
    log1p(dhea_nmol_l) ~ mems_time_since_wake + mems_time_since_wake_30_min + (1 | subject_id),
    data = q3_dhea_data
)
summary(dhea_model)
```

```{r}
grid_dhea <- tibble(
  mems_time_since_wake = seq(
    min(q3_dhea_data$mems_time_since_wake, na.rm = TRUE),
    max(q3_dhea_data$mems_time_since_wake, na.rm = TRUE),
    length.out = 200
  )
) %>%
  mutate(
    mems_time_since_wake_30_min = pmax(0, mems_time_since_wake - 0.5)
  ) %>%
  mutate(
    fit_log  = predict(dhea_model, newdata = ., re.form = NA),
    fit_nmol = expm1(fit_log)
  )

ggplot(q3_dhea_data, aes(x = mems_time_since_wake, y = dhea_nmol_l)) +
  geom_point(alpha = 0.35, size = 1, na.rm = TRUE) +
  geom_line(
    data = grid_dhea,
    
    aes(x = mems_time_since_wake, y = fit_nmol),
    color = "#1f77b4",
    linewidth = 1.1
  ) +
  labs(
    title = "DHEA vs Time Since Wake",
    subtitle = "Points = observed DHEA (nmol/L); line = fitted (fixed effects only; back-transformed)",
    x = "Time since wake (hours)",
    y = "DHEA (nmol/L)"
  ) +
  theme_minimal()
```


# Introduction

# Methods

# Results

# Discussion



