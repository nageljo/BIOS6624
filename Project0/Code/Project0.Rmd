---
title: "Evaluation of At-Home Sample Timing for Diurnal Hormone Level Characterization"
author: ""
date: ""
output: pdf_document
fontsize: 12pt
mainfont: Helvetica
number_sections: true
geometry: margin=1in
header-includes:
  - \usepackage{setspace}
  - \doublespacing
  # - \usepackage{float}
  # - \floatplacement{table}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(list(echo = FALSE, include = FALSE))
```

```{r}
# read in packages
library(tidyverse)
library(naniar)
library(janitor)
library(lme4)
library(lmerTest)
library(emmeans)
library(gtsummary)
library(gt)
library(knitr)
library(kableExtra)
library(patchwork)
library(broom.mixed)

# Set all plots to 'Hold' position
# opts_chunk$set(fig.pos = "H", out.extra = "")

# Set kableExtra to always use hold_position globally

```

```{r}
# define outlier outcome values
HIGH_CORTISOL = 80
HIGH_DHEA = 5.205
```


```{r}
(
    # read in dataframe
    read_csv(
        '../Data/Project0_Clean_v2.csv',
        show_col_types = FALSE
    )
    
    # clean names
    %>% clean_names()
    
    # create time since wake columns
    %>% group_by(subject_id, collection_date)
    %>% arrange(collection_sample, .by_group = TRUE)
    %>% fill(sleep_diary_reported_wake_time, .direction = "down")
    %>% ungroup()
    %>% mutate(
        .after = sleep_diary_reported_wake_time,
        mems_time_since_wake =
            as.numeric(me_ms_clock_time - sleep_diary_reported_wake_time) / 3600,
        booklet_time_since_wake =
            as.numeric(booket_clock_time - sleep_diary_reported_wake_time) / 3600,
    )
    
    # create 15 and 30 min window indicator columns
    %>% mutate(
        mems_adherence_15 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(mems_time_since_wake - 30/60) <= 7.5/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(mems_time_since_wake - 10) <= 7.5/60, 1, 0)
        ),
        mems_adherence_30 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(mems_time_since_wake - 30/60) <= 15/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(mems_time_since_wake - 10) <= 15/60, 1, 0)
        ),
        booklet_adherence_15 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(booklet_time_since_wake - 30/60) <= 7.5/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(booklet_time_since_wake - 10) <= 7.5/60, 1, 0)
        ),
        booklet_adherence_30 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(booklet_time_since_wake - 30/60) <= 15/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(booklet_time_since_wake - 10) <= 15/60, 1, 0)
        )
    )
    # exclude extreme values and subject 3037
    %>% mutate(
        cortisol_nmol_l = case_when(
            cortisol_nmol_l >= HIGH_CORTISOL ~ NA_real_,
            subject_id == 3037 ~ NA_real_,
            .default = cortisol_nmol_l
        ),
        dhea_nmol_l = case_when(
            dhea_nmol_l >= HIGH_DHEA ~ NA_real_,
            subject_id == 3037 ~ NA_real_,
            .default = dhea_nmol_l
        ),
    )
) -> cort
```

```{r, include=TRUE}
# 1. Define Valid/Invalid Logic
cort_quality <- cort %>%
  mutate(
    .keep = "none",
    `Booklet Recording Time` = !is.na(booket_clock_time),
    `MEMS Cap Recording Time` = !is.na(me_ms_clock_time),
    `Both Time Recordings` = !is.na(booket_clock_time) & !is.na(me_ms_clock_time),
    `Sleep Diary Wake Time` = !is.na(sleep_diary_reported_wake_time),
    `Cortisol (nmol/L)` = !is.na(cortisol_nmol_l),
    `DHEA (nmol/L)` = !is.na(dhea_nmol_l)
  )

# Create Component Tables
# Table A: Valid Counts & Total N
t_valid <- cort_quality %>%
  tbl_summary(
    statistic = all_dichotomous() ~ "{n}",
    missing = "no",
  ) %>%
  add_n() %>%
  modify_header(
    n = "**Expected**",
    stat_0 = "**Observed**"
  )

# Table B: Missing Counts (N)
t_miss_n <- cort_quality %>%
  mutate(across(everything(), ~!.)) %>% # Invert booleans
  tbl_summary(
    statistic = all_dichotomous() ~ "{n}",
    missing = "no",
  ) %>%
  modify_header(stat_0 = "**Missing**")

# Table C: Missingness Percentage (%)
t_miss_pct <- cort_quality %>%
  mutate(across(everything(), ~!.)) %>% # Invert booleans
  tbl_summary(
    statistic = all_dichotomous() ~ "{p}%",
    missing = "no",
  ) %>%
  modify_header(stat_0 = "**Missingness**")

# Merge tables
missingness_table <- tbl_merge(
  tbls = list(t_valid, t_miss_n, t_miss_pct),
  tab_spanner = FALSE
) %>%
  modify_caption("Data Availability and Missingness")
```

```{r}
# model for Q1
agreement_model = lmer(
    mems_time_since_wake ~ booklet_time_since_wake + (1 | subject_id),
    data = cort
)
# summary(agreement_model)
```

```{r}
# Extract coefficients, calculate custom tests, and rename terms
agreement_table <- tidy(agreement_model, effects = "fixed", conf.int = TRUE) %>%
  mutate(
    # Define the null hypothesis value (0 for Intercept, 1 for Slope)
    null_hypothesis = ifelse(term == "(Intercept)", 0, 1),
    
    # Recalculate t-statistic based on the specific null hypothesis
    statistic = (estimate - null_hypothesis) / std.error,
    
    # Recalculate p-value using df from the model summary
    df = summary(agreement_model)$coefficients[, "df"],
    p.value = 2 * (1 - pt(abs(statistic), df)),
    
    # RENAME THE TERMS HERE
    term = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "booklet_time_since_wake" ~ "Slope",
      TRUE ~ term
    )
  ) %>%
  # Select and format columns for the final table
  mutate(
    .keep = "none",
    Term = term,
    Estimate = round(estimate, 3),
    `95% CI` = paste0("(", round(conf.low, 3), ", ", round(conf.high, 3), ")"),
    `Hypothesis` = paste0("beta = ", null_hypothesis),
    `t-value` = round(statistic, 2),
    `p-value` = format.pval(p.value, digits = 3, eps = 0.001)
  )

# convert to kable
agreement_table <- kable(agreement_table, caption = "Agreement Model Fixed Effects") %>% row_spec(0, bold = TRUE)
```


```{r}
# scatter plot with fitted line for Q1
# get betas from the model
betas <- fixef(agreement_model)

agreement_plot <- ggplot(data = cort, aes(x = booklet_time_since_wake, y = mems_time_since_wake)) +
  geom_point(alpha = 0.3, size = 2, shape = 1, na.rm = TRUE) + 
  geom_abline(aes(intercept = 0, slope = 1, 
                  color = "Perfect Agreement (y=x)", 
                  linetype = "Perfect Agreement (y=x)"), 
              linewidth = 0.8) +
  geom_abline(aes(intercept = betas[1], slope = betas[2], 
                  color = "Fitted Model", 
                  linetype = "Fitted Model"), 
              linewidth = 1.2) +
  scale_color_manual(name = NULL, 
                     values = c("Fitted Model" = "darkred", 
                                "Perfect Agreement (y=x)" = "grey50")) +
  scale_linetype_manual(name = NULL, 
                        values = c("Fitted Model" = "solid", 
                                   "Perfect Agreement (y=x)" = "dotted")) +
  coord_fixed() +
  labs(
    x = "Booklet Time Since Wake (Hours)",
    y = "MEMS Time Since Wake (Hours)"
  ) +
  theme_classic() +
  theme(legend.position.inside = c(0.25, 0.9))
```

```{r, include=TRUE}
# table of adherence values
(
    cort
    %>% filter(collection_sample %in% c(2, 4))
    %>% summarise(
        across(
            matches("adherence"),
            ~mean(., na.rm = TRUE)
        )
    )
    %>% round(3)
    %>% pivot_longer(
        cols = everything(),
        names_to = c("recording_method", ".value"),
        names_pattern = c("(.*)_(.*_.*)")
    )
) -> table_data

adherence_table <- table_data %>%
  mutate(
    recording_method = recode(recording_method, 
                              "mems" = "MEMS Cap", 
                              "booklet" = "Booklet"),
    # Convert to percentages
    adherence_15 = scales::percent(adherence_15, accuracy = 0.1),
    adherence_30 = scales::percent(adherence_30, accuracy = 0.1)
  ) %>%
  rename(
    `Recording Method` = recording_method,
    `15-Minute Window` = adherence_15,
    `30-Minute Window` = adherence_30
  ) %>%
  kable(
    format = "latex", 
    booktabs = TRUE, 
    caption = "Adherence Rates by Recording Method",
    align = c("l", "c", "c"),
    escape = TRUE 
  ) %>%
  # 3. Bold the column headers
  row_spec(0, bold = TRUE) %>%
  add_header_above(c(" " = 1, "Adherence Thresholds" = 2), bold = TRUE)
```


```{r}
# build cortisol model
cort_model <- lmer(
    log(cortisol_nmol_l) ~
        booklet_time_since_wake +
        pmax(0, booklet_time_since_wake - 0.5) +
        (1 | subject_id),
    data = cort
)
```

```{r}
# create plot of fitted regression line over the original data
pred_data <- data.frame(
  booklet_time_since_wake = seq(
    min(cort$booklet_time_since_wake, na.rm = TRUE), 
    max(cort$booklet_time_since_wake, na.rm = TRUE), 
    length.out = 200
  )
)

# get predicted values
pred_data$pred_log <- predict(cort_model, newdata = pred_data, re.form = NA)
pred_data$pred_cortisol <- exp(pred_data$pred_log)

plot_cort_model <- (
    ggplot(cort, aes(x = booklet_time_since_wake, y = cortisol_nmol_l))
    + geom_point(alpha = 0.3, na.rm = TRUE)
    + geom_line(data = pred_data, aes(y = pred_cortisol), color = "darkred", linewidth = 2)
    + labs(
        x = "Booklet Time Since Wake (Hours)",
        y = "Cortisol (nmol/L)"
    )
    + theme_classic()
)
```


```{r}
# build DHEA model
dhea_model <- lmer(
    log(dhea_nmol_l) ~
        booklet_time_since_wake +
        pmax(0, booklet_time_since_wake - 0.5) +
        (1 | subject_id),
    data = cort
)
```

```{r}
# Function to extract relative changes
get_relative_change <- function(model, label) {
  
  # Calculate Slopes
  slope_early <- emtrends(model, ~1, var = "booklet_time_since_wake", 
                          at = list(booklet_time_since_wake = 0.1)) %>%
                 summary(infer = c(TRUE, TRUE)) %>% 
                 as.data.frame()
  
  slope_late <- emtrends(model, ~1, var = "booklet_time_since_wake", 
                         at = list(booklet_time_since_wake = 1.0)) %>%
                summary(infer = c(TRUE, TRUE)) %>% 
                as.data.frame()
  
  # Combine results
  res <- rbind(slope_early, slope_late)
  
  # Apply Transformations
  res <- res %>%
    mutate(
      period = c("0-30 min (total change)", "> 30 min (change/hour)"),
      time_multiplier = c(0.5, 1.0),
      
      # Relative Change %
      rel_change_pct = 100 * (exp(booklet_time_since_wake.trend * time_multiplier) - 1),
      
      # 95% CIs
      lower_ci = 100 * (exp(lower.CL * time_multiplier) - 1),
      upper_ci = 100 * (exp(upper.CL * time_multiplier) - 1),
      
      outcome = label
    ) %>%
    # Select columns
    select(outcome, period, rel_change_pct, lower_ci, upper_ci, p.value)
  
  return(res)
}
```


```{r}
# Generate Table
table_cort <- get_relative_change(cort_model, "Cortisol")
table_dhea <- get_relative_change(dhea_model, "DHEA")

final_table <- rbind(table_cort, table_dhea) %>% 
    mutate(
        .keep = "none",
        Hormone = outcome,
        Period = period,
        `% Change` = rel_change_pct,
        `95% CI` = paste0("(", round(lower_ci, 2), ", ", round(upper_ci, 2), ")"),
        `p-value` = format.pval(p.value, digits = 3, eps = 0.001)
    )

# COnvert to kable
hormone_models_table <- kable(final_table, digits = 2, caption = "Relative Changes in Cortisol and DHEA") %>% row_spec(0, bold = TRUE)
```

```{r}
# create plot of fitted regression line over the original data
pred_data <- data.frame(
  booklet_time_since_wake = seq(
    min(cort$booklet_time_since_wake, na.rm = TRUE), 
    max(cort$booklet_time_since_wake, na.rm = TRUE), 
    length.out = 200
  )
)
pred_data$pred_log <- predict(dhea_model, newdata = pred_data, re.form = NA)
pred_data$pred_dhea <- exp(pred_data$pred_log)

plot_dhea_model <- (
    ggplot(cort, aes(x = booklet_time_since_wake, y = dhea_nmol_l))
    + geom_point(alpha = 0.3, na.rm = TRUE)
    + geom_line(data = pred_data, aes(y = pred_dhea), color = "darkred", linewidth = 2)
    + labs(
        x = "Booklet Time Since Wake (Hours)",
        y = "DHEA (nmol/L)"
    )
    + theme_classic()
)
```

# Introduction

Cortisol and dehydroepiandrosterone (DHEA) are hormones released by the endocrine system that help regulate physiological responses to stress. These hormones exhibit pronounced diurnal patterns, meaning their levels change systematically across the day. Understanding these patterns is important as disruptions of these rhythms may indicate altered regulation of the stress response system.

The data analyzed in this report come from a study designed to evaluate a novel at-home saliva collection method for characterizing diurnal hormone profiles. Specifically, the investigator tested the Saliva Procurement and Integrated Testing (SPIT) booklet, which collects saliva on filter paper strips, and compared timing information recorded by the booklet to a Medication Event Monitoring System (MEMS) cap on the storage bottle. The dataset included 31 subjects who collected saliva samples four times per day for three consecutive days. Sampling was scheduled at waking, 30 minutes post-waking, before lunch, and 600 minutes post-waking. Subjects were allowed to define their own waking time and before lunch timing. The goals of the study were to determine the agreement between the booklet and MEMS cap samples times, measure the adherence to the study protocol's sampling times, and characterize the diurnal patterns of cortisol and DHEA. These goals were assessed with the following statistical hypotheses:

1. Measurement Method Agreement: Is there significant additive or proportional bias between the booklet and MEMS measuring cap sample times?

2. Sample Timing Adherence: What proportion of samples fell within $\pm 7.5$ minutes (good) and $\pm 15$ minutes (adequate) of the target times for the 30-min and 10-hour post-waking collections?

3. Diurnal Hormone Patterns: What is the change in hormone levels from waking to 30 minutes post waking? What is the change per hour in hormone levels after 30 minutes post waking?

# Methods

The key measures in the dataset (subject's sleep diary wake time, booklet sample time, MEMS cap sample time, cortisol (nmol/l), and DHEA (nmol/l)) were assessed for missingness and outliers. Outliers were defined as cortisol $\ge 80$ nmol/l and DHEA $\ge 5.205$ nmol/l (the assay upper detection limit for DHEA). Any samples exceeding these limits and all samples for subjects with multiple readings at the DHEA assay limit were excluded from the diurnal pattern analysis. Cortisol and DHEA were log transformed to reduce skewness and mitigate the violation of regression assumptions. The time between sleep diary waking time and sample collection was calculated for both the booklet and MEMS cap samples times. A table of descriptive statistics was created for the primary variables in the analysis. Prior to analysis for research question 3, outlier values of cortisol and DHEA were set to missing and one patient (subject 3037) was removed due to multiple DHEA readings at the assay limit.

All analysis were performed using a type one error rate ($\alpha$) of 0.05. All models and figures were created with R version 4.5.1. ChatGPT version 5.2 was used to debug code, outline the report, and copy-edit the report.

## Measurement Method Agreement

To address the agreement and bias between timing methods, we estimated the additive and proportional bias between the MEMS cap and booklet sample times. Additive bias represents a systematic difference in the reported times independent of time of day while proportional bias represents a relationship in the difference between the measurements that changes throughout the day. A linear mixed-effects model was fit with MEMS cap sample time since wake as the outcome and booklet sample time since wake as the predictor with a subject-specific random intercept to account for repeated measures. Additive bias was evaluated by testing whether the fixed effect intercept was different from 0 and proportional bias was evaluated by testing whether the fixed effect slope was different from 1. This relationship was also visualized.

## Sample Timing Adherence

To evaluate adherence to the study protocol's collection schedule, we assessed the proportion of samples that fell within $\pm 7.5$ minutes (good adherence) and $\pm 15$ minutes (adequate adherence) of the target collection time for the 30-minute and 10-hour post-waking collections. For each sample, we calculated the absolute difference between the observed collection time and the target collection time and created indicator variables for each of the adherence windows ($\pm 7.5$ and  $\pm 15$ minutes). The outcome was defined as the proportion of observed (nonmissing) samples that fell within the window. This was performed for both the booklet and MEMS cap times.

## Diurnal Hormone Patterns

To characterize diurnal patterns in cortisol and DHEA, we estimated changes over two intervals: waking to 30 minutes post waking and after 30 minutes post waking. The booklet sample time was used to define measurement time. This was decided based on the agreement and bias analysis as well as missingness. As described above, hormone concentrations were log transformed to reduce right skewness prior to modeling. Piecewise linear mixed-effects models were fit with time since waking as the predictor and hormone level as the outcome, including a subject-specific random intercept to account for repeated measures. Models included a single knot at 30 minutes (0.5 hours) to allow for distinct trends before and after the knot. The relative (multiplicative) change from waking to 30 minutes post waking and the relative change per hour after 30 minutes were estimated from the fitted models.


# Results

Data avalability and missingness are summarized in **Table 1**. Notably, the  booklet provided more complete timing data (9.4% missing) compared to the MEMS cap system (16% missing). Both hormone measurements had similar levels of missingness (~5% missing).

```{r, include=TRUE}
missingness_table %>%
  as_kable_extra(booktabs = TRUE)
```

## Measurement Method Agreement

The linear mixed-effect model comparing the booklet sample times to the MEMS cap sample times (**Table 2**) revealed significant additive bias between the measurements. The model's slope was not significantly different from 1 (p-value = 0.2) indicating no proportional bias between the measurement  methods. This indicates that the average time difference between the measurement methods did not change with the time of day. However, the intercept was significantly different from 0 (p-value < 0.001) indicating additive bias. At waking, MEMS cap sample times were on average 10.2 minutes (95% CI: 4.4, 15.9) minutes later than booklet sample times. The relationship is visualized in **Figure 1**. While the model showed slight additive bias between the measurements, the plot shows high agreement between the two methods, with the fitted and perfect agreement ($y=x$) lines almost completely overlapping.

```{r, include=TRUE}
agreement_table
```

```{r, include=TRUE, fig.align='center',fig.cap="Plot of Booklet vs MEMS Cap Times with LMM Fit"}
agreement_plot
```

## Sample Timing Adherence

Adherence to the study protocol varied by recording method (**Table 3**). For the good adherence threshold ($\pm 7.5$ minutes), only 41.8% of the MEMS cap samples were within the window, compared to 62.9% reported in the booklet. A similar pattern was observed for the adequate adherence threshold ($\pm 15$ minutes), where the booklet-reported adherence (73.7%) was substantially higher than the MEMS cap adherence (54.2%).

```{r, include=TRUE}
adherence_table
```

## Diurnal Hormone Patterns

For the analysis of diurnal hormone patters, the booklet time since waking was used as the predictor. While there was slight bias between measurements, the overall agreement between the MEMS cap and booklet times was high and the booklet times had less missingness. The parameters of interest estimated from the linear mixed-effects models of cortisol and DHEA are shown in **Table 4**. Both cortisol and DHEA were modeled on the log scale, so the resulting coefficients indicate relative (multiplicative) change in hormone level. There was, on average, a 20.2% (95% CI: -3.1, 49.1) relative increase in cortisol from waking to 30 minutes post waking; this increase was not significant (p-value = 0.093). After 30 minutes post waking, cortisol decreased by an average of 12.5% (95% CI: 10.6, 14.4) per hour, a significant decrease (p-value < 0.001). From waking to 30 minutes post waking, there was a significant average relative decrease in DHEA of 41.3% (p-value < 0.001; 95% CI: 29.7, 51.0). After 30 minutes post waking, there was an average relative decrease in DHEA of 8.8% (95% CI: 7.2, 10.5) per hour; this decrease was significant (p-value < 0.001). These relationships are visualized in **Figure 2** for both models. Note that the relationships are visualized on the original nmol/L scale.

```{r, include=TRUE}
hormone_models_table
```

```{r, include=TRUE, fig.cap="Fitted Diurnal Trajectories of Cortisol and DHEA"}
plot_cort_model + plot_dhea_model
```

# Discussion and Conclusions

The evaluation of the sampling time data between the booklet and MEMS cap reveals that the SPIT booklet is an effective method for at-home data collection especially with respect to data completeness; the booklet sample times has less missingness (9.4%) than the MEMS cap times (16%). However, there was a significant additive bias between the two timing methods with MEMS cap times recorded at waking on average 10.2 minutes later than booklet times. This implies that patients likely recorded intended sample times somewhat before the moment they opened the bottle. Importantly, this bias remained constant and did not change throughout the day.

Protocol adherence appeared substantially higher when based on self-reported booklet entries rather than objective MEMS timestamps. Specifically, the proportion of samples meeting the criteria for good adherence ($\pm$ 7.5 minutes) was 21.1 percentage points higher in the booklet compared to the MEMS cap, while adequate adherence ($\pm$ 15 minutes) was 19.5 percentage points higher. This large discrepancy, coupled with the observed additive bias, suggests that participants may have recorded times that aligned better with the prescribed schedule than their actual sampling behavior reflected.

Biologically, the study partially confirmed the investigatorâ€™s hypotheses regarding diurnal hormone patterns. Cortisol exhibited the expected trajectory of an initial rise (20.2% increase) followed by a steady decline, although the initial rise did not reach statistical significance ($p=0.093$), likely due to the modest sample size ($n=31$). Conversely, DHEA deviated from the hypothesized sharp increase, instead showing a significant 41.3% relative decrease in the first 30 minutes post-waking. This unexpected result suggests the DHEA awakening response may differ from Cortisol, potentially peaking strictly at waking or declining earlier than anticipated.

Several limitations should be considered. First, the sample size ($n=31$) was relatively small, which likely contributed to the lack of statistical significance for the cortisol rise despite a relatively large effect size. Second, the reliance on self-reported sleep diary wake times introduces a source of error that affects all time since wake calculations. Finally, the discrepancy between booklet and MEMS adherence rates suggests that self-reported timing data should be interpreted with caution, as it may overestimate protocol compliance.


# Reproducible Research

Github Link: https://github.com/nageljo/BIOS6624

Data Path: `C:\Users\josep\OneDrive\AdvancedData\BIOS6624\Project0\Data\Project0_Clean_v2.csv`




