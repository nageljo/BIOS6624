---
title: "Project 0"
author: "Joseph Nagel"
date: "`r Sys.Date()`"
output: pdf_document
fontsize: 12pt
mainfont: Helvetica
number_sections: true
geometry: margin=1in
header-includes:
  - \usepackage{setspace}
  - \doublespacing
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(list(echo = FALSE, include = FALSE))
```

```{r}
## read in packages
library(tidyverse)
library(naniar)
library(janitor)
library(lme4)
library(lmerTest)
library(emmeans)
```

```{r}
## define outlier outcome values
HIGH_CORTISOL = 80
HIGH_DHEA = 5.205
```


```{r}
(
    ## read in dataframe
    read_csv(
        '../Data/Project0_Clean_v2.csv',
        show_col_types = FALSE
    )
    
    ## clean names
    %>% clean_names()
    
    ## create time since wake columns
    %>% group_by(subject_id, collection_date)
    %>% arrange(collection_sample, .by_group = TRUE)
    %>% fill(sleep_diary_reported_wake_time, .direction = "down")
    %>% ungroup()
    %>% mutate(
        .after = sleep_diary_reported_wake_time,
        mems_time_since_wake =
            as.numeric(me_ms_clock_time - sleep_diary_reported_wake_time) / 3600,
        booklet_time_since_wake =
            as.numeric(booket_clock_time - sleep_diary_reported_wake_time) / 3600,
    )
    
    ## create 15 and 30 min window indicator columns
    %>% mutate(
        mems_adherence_15 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(mems_time_since_wake - 30/60) <= 7.5/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(mems_time_since_wake - 10) <= 7.5/60, 1, 0)
        ),
        mems_adherence_30 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(mems_time_since_wake - 30/60) <= 15/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(mems_time_since_wake - 10) <= 15/60, 1, 0)
        ),
        booklet_adherence_15 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(booklet_time_since_wake - 30/60) <= 7.5/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(booklet_time_since_wake - 10) <= 7.5/60, 1, 0)
        ),
        booklet_adherence_30 = case_when(
            collection_sample %in% c(1, 3) ~ NA_real_,
            collection_sample == 2 ~ if_else(abs(booklet_time_since_wake - 30/60) <= 15/60, 1, 0),
            collection_sample == 4 ~ if_else(abs(booklet_time_since_wake - 10) <= 15/60, 1, 0)
        )
    )
) -> cort
```

```{r}
## check for cortisol_nmol_l outliers ----- THIS GOES IN QUESTION 3 MODELING: mention in methods that we checked for bad values
cort %>% filter(cortisol_nmol_l >= 80)
```

```{r}
## check for dhea_nmol_l outliers ----- THIS GOES IN QUESTION 3 MODELING: mention in methods that we checked for bad values
cort %>% filter(dhea_nmol_l >= 5.205)
```

```{r}
## check id 3037
cort %>% filter(subject_id == 3037)
```


```{r}
## check missingness
# vis_miss(cort)
```

```{r}
## per column missingness
(
    cort
    %>% select(c(booket_clock_time, me_ms_clock_time, sleep_diary_reported_wake_time, cortisol_nmol_l, dhea_nmol_l))
    %>% summarise(
        across(
            everything(),
            ~mean(is.na(.))
        )
    )
    %>% round(2)
)
```

```{r}
## model for Q1

agreement_model_prop = lmer(
    mems_time_since_wake ~ booklet_time_since_wake + (1 | subject_id),
    data = cort
)
agreement_model_add = lmer(
    mems_time_since_wake - booklet_time_since_wake ~ (1 | subject_id),
    data = cort
)
summary(agreement_model_prop)
fixef(agreement_model_prop, parm = "beta_")
confint(agreement_model_prop, parm = "beta_")
```

```{r}
## plot for Q1
(
    ggplot(data = cort, aes(x = booklet_time_since_wake, y = mems_time_since_wake))
    + geom_abline(intercept = 0, slope = 1)
    + geom_point(alpha = 0.2, size = 3, na.rm = TRUE)
    + labs(
        x = "Booklet Time Since Wake (Hours)",
        y = "MEMs Time Since Wake (Hours)"
    )
    + theme_classic()
)
```

```{r}
## test if slope is different from 1
## H0: slope = 1
contest(agreement_model_prop, L = c(0, 1), rhs = 1)
```



```{r}
## table for Q2
(
    cort
    %>% filter(collection_sample %in% c(2, 4))
    # %>% filter(across(matches("adherence"), ~!is.na(.)))
    %>% summarise(
        across(
            matches("adherence"),
            ~mean(., na.rm = TRUE)
        )
    )
    %>% round(3)
    %>% pivot_longer(
        cols = everything(),
        names_to = c("recording_method", ".value"),
        names_pattern = c("(.*)_(.*_.*)")
    )
)
```

```{r}
(
    cort
    %>% select(subject_id, collection_date, daynumb)
    %>% summarise(
        .by = subject_id,
        n_dates = n_distinct(collection_date),
        n_daynumbs = n_distinct(daynumb),
    )
)
```


```{r}
(
    ggplot(data = cort %>% filter(mems_time_since_wake >= 0.5), aes(x = mems_time_since_wake, y = log1p(dhea_nmol_l + 1)))
    + geom_point()
)
```

```{r}
hist(as.numeric(cort$sleep_diary_reported_wake_time) / 3600)
```

```{r}
anomalous_dhea_subjects <- (
    cort
    %>% summarise(
        .by = subject_id,
        n_limit_dhea = sum(dhea_nmol_l >= HIGH_DHEA, na.rm = TRUE)
    )
    %>% filter(n_limit_dhea > 1)
)
anomalous_dhea_subjects
```

```{r}
## cortisol model
(
    cort
    ## exclusion criteria
    %>% filter(!(subject_id %in% select(anomalous_dhea_subjects, subject_id)))
    %>% filter(cortisol_nmol_l <= HIGH_CORTISOL)
    
    ## create col for mems > 0.5
    %>% mutate(mems_time_since_wake_30_min = pmax(0, mems_time_since_wake - 0.5))
) -> q3_cort_data
    
    ## build model
cort_model <- lmer(
    log(cortisol_nmol_l) ~ mems_time_since_wake + mems_time_since_wake_30_min + (1 | subject_id),
    data = q3_cort_data
)
summary(cort_model)
```

```{r}

# Create a smooth grid of time values for a clean fitted line
grid <- tibble(
  mems_time_since_wake = seq(
    min(q3_cort_data$mems_time_since_wake, na.rm = TRUE),
    max(q3_cort_data$mems_time_since_wake, na.rm = TRUE),
    length.out = 200
  )
) %>%
  mutate(
    mems_time_since_wake_30_min = pmax(0, mems_time_since_wake - 0.5)
  )

# Predict from fixed effects only, then back-transform to nmol/L
grid <- grid %>%
  mutate(
    fit_log = predict(cort_model, newdata = grid, re.form = NA),
    fit_nmol = exp(fit_log)
  )

# Plot raw points + fitted line (original scale)
ggplot(q3_cort_data, aes(x = mems_time_since_wake, y = cortisol_nmol_l)) +
  geom_point(alpha = 0.35, size = 1, na.rm = TRUE) +
  geom_line(data = grid, aes(x = mems_time_since_wake, y = fit_nmol),
            color = "#1f77b4", linewidth = 1.1) +
  labs(
    title = "Cortisol vs Time Since Wake",
    subtitle = "Points = observed cortisol (nmol/L); line = fitted (fixed effects; back-transformed)",
    x = "Time since wake (hours)",
    y = "log(Cortisol + 1)"
  ) +
  theme_minimal()
```


```{r}
## define dhea analysis dataset
(
    cort
    ## exclusion criteria
    %>% filter(!(subject_id %in% select(anomalous_dhea_subjects, subject_id)))
    %>% filter(dhea_nmol_l < HIGH_DHEA)
    
    ## create col for mems > 0.5
    %>% mutate(
        mems_time_since_wake_30_min = pmax(0, mems_time_since_wake - 0.5)
    )
) -> q3_dhea_data

## build model
dhea_model <- lmer(
    log(dhea_nmol_l) ~ mems_time_since_wake + mems_time_since_wake_30_min + (1 | subject_id),
    data = q3_dhea_data
)
summary(dhea_model)
```

```{r}
grid_dhea <- tibble(
  mems_time_since_wake = seq(
    min(q3_dhea_data$mems_time_since_wake, na.rm = TRUE),
    max(q3_dhea_data$mems_time_since_wake, na.rm = TRUE),
    length.out = 200
  )
) %>%
  mutate(
    mems_time_since_wake_30_min = pmax(0, mems_time_since_wake - 0.5)
  ) %>%
  mutate(
    fit_log  = predict(dhea_model, newdata = ., re.form = NA),
    fit_nmol = exp(fit_log)
  )

ggplot(q3_dhea_data, aes(x = mems_time_since_wake, y = dhea_nmol_l)) +
  geom_point(alpha = 0.35, size = 1, na.rm = TRUE) +
  geom_line(
    data = grid_dhea,
    
    aes(x = mems_time_since_wake, y = fit_nmol),
    color = "#1f77b4",
    linewidth = 1.1
  ) +
  labs(
    title = "DHEA vs Time Since Wake",
    subtitle = "Points = observed DHEA (nmol/L); line = fitted (fixed effects only; back-transformed)",
    x = "Time since wake (hours)",
    y = "DHEA (nmol/L)"
  ) +
  theme_minimal()
```


# Introduction

Cortisol and dehydroepiandrosterone (DHEA) are hormones released by the endocrine system that help regulate physiological responses to stress. These hormones exhibit pronounced diurnal patterns, meaning their levels change systematically across the day. Understanding these patterns is important as disruptions of these rhythms may indicate altered regulation of the stress response system.

The data analyzed in this report come from a study designed to evaluate a novel at-home saliva collection method for characterizing diurnal hormone profiles. Specifically, the investigator tested the Saliva Procurement and Integrated Testing (SPIT) booklet, which collects saliva on filter paper strips, and compared timing information recorded by the booklet to an electronic monitoring cap on the storage bottle. The dataset included 31 subjects who collected saliva samples four times per day for three consecutive days. Sampling was scheduled at waking, 30 minutes post-waking, before lunch, and 600 minutes post-waking. Subjects were allowed to define their own waking time and before lunch timing. The goals of the study were to determine the agreement between the booklet and electronic monitoring cap samples times, measure the adherence to the study protocol's sampling times, and characterize the diurnal patterns of cortisol and DHEA. These goals were assessed with the following statistical hypotheses:

1. Is there significant additive or proportional bias between the booklet and electronic measuring cap sample times?

2. What proportion of samples fell within $\pm 7.5$ minutes (good) and $\pm 15$ minutes (adequate) of the target times for the 30-min and 10-hour post-waking collections?

3. For cortisol and DHEA: What is the change in hormone level from waking to 30 minutes post waking? What is the change per hour in hormone level after 30 minutes post waking?

# Methods

The key measures in the dataset (subject's wake time, booklet sample time, electronic monitoring cap sample time, cortisol (nmol/l), and DHEA (nmol/l)) were assessed for missingness and outliers. Outliers were defined as cortisol $\ge 80$ nmol/l and DHEA $\ge 5.205$ nmol/l (the assay upper detection limit for DHEA). Any samples exceeding these limits and all samples for subjects with multiple readings at the DHEA assay limit were excluded from the diurnal pattern analysis. Cortisol and DHEA were log-plus-one-transformed to reduce skewness and mitigate the violation of regression assumptions. The time between waking and sample collection was calculated for both the booklet and electronic cap samples times.

To address the agreement and bias between timing methods, we estimated the additive and proportional bias between the electronic cap and booklet sample times. Additive bias represents a systematic difference in the reported times independent of time of day while proportional bias represents a relationship in the difference between the measurements that changes throughout the day. A linear mixed-effects model was fit with electronic cap sample time since wake as the outcome and booklet sample time since wake as the predictor with a subject-specific random intercept to account for repeated measures. Additive bias was evaluated by testing whether the fixed effect intercept was different from 0 and proportional bias was evaluated by testing whether the fixed effect slope was different from 1.

To evaluate adherence to the study protocol's collection schedule, we assessed the proportion of samples that fell within $\pm 7.5$ minutes (good adherence) and $\pm 15$ minutes (adequate adherence) of the target collection time for the 30-minute and 10-hour post-waking collections. For each sample, we calculated the absolute difference between the observed collection time and the target collection time and created indicator variables for each of the adherence windows ($\pm 7.5$ and  $\pm 15$ minutes). The outcome was defined as the proportion of observed (nonmissing) samples that fell within the window. This was performed for both the booklet and electronic cap times.

To characterize diurnal patterns in cortisol and DHEA, we estimated changes over two intervals: waking to 30 minutes post waking and after 30 minutes post waking. The sample time source (booklet vs. electronic cap) used to define measurement time was selected based on the agreement and bias analysis. As described above, hormone concentrations were log transformed to reduce right skewness prior to modeling. Piecewise linear mixed-effects models were fit with time since waking as the predictor and hormone level as the outcome, including a subject-specific random intercept to account for repeated measures. Models included a single knot at 30 minutes (0.5 hours) to allow distinct linear trends before and after the knot. The relative (multiplicative) change from waking to 30 minutes post waking and the relative change per hour after 30 minutes were estimated from the fitted model. For each of the hormones, any outlier values were removed prior to analysis and a complete case analysis was performed on the remained observations.


# Results

**Table 1** shows the missingness for the measures of interest in the dataset. 



# Discussion



