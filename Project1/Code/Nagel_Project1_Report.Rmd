---
title: ""
author: ""
date: ""
output: pdf_document
fontsize: 12pt
mainfont: Helvetica
number_sections: true
geometry: margin=1in
header-includes:
  - \usepackage{setspace}
  - \doublespacing
  - \usepackage{float}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(list(echo = FALSE, include = FALSE))
```

```{r}
# read in packages
library(tidyverse)
library(naniar)
library(janitor)
library(lme4)
library(lmerTest)
library(emmeans)
library(gtsummary)
library(gt)
library(knitr)
library(kableExtra)
library(patchwork) 
library(broom.mixed)
```

```{r}
(
    read_csv('../Data/hiv_6624_final.csv', show_col_types = FALSE, name_repair = "unique_quiet")
    %>% clean_names()
) -> hiv
```


```{r}
# read in data
(
    hiv
    # remove bad bmi values
    %>% mutate(
        bmi = if_else(bmi %in% c(-1, 999), NA_real_, bmi),
        timepoint = if_else(years == 0, 'baseline', as.character(years)),
        hard_drugs = factor(hard_drugs),
        smoke_recode = recode_values(
            smoke,
            1 ~ "Never Smoked",
            2 ~ "Former Smoker",
            3 ~ "Current Smoker",
            NA ~ NA_character_,
            default = "Not Handled"
        ),
        race_recode = recode_values(
            race,
            1 ~ "Non-Hispanic White",
            2:8 ~ "Other",
            NA ~ NA_character_,
            default = "Not Handled"
        ),
        edu_recode = recode_values(
            educbas,
            1:4 ~ "No College Degree",
            5:7 ~ "College Degree or Greater",
            NA ~ NA_character_,
            default = "Not Handled"
        )
    )
    
    # hiv positive only
    %>% filter(hivpos == 1)
    
    # filter to baseline and year 2
    %>% filter(years %in% c(0, 2))
    %>% select(newid, timepoint, agg_ment, agg_phys, leu3n,
               vload, hard_drugs, adh, age, bmi, smoke, educbas, race)
    %>% pivot_wider(
        id_cols = newid,
        names_from = timepoint,
        names_glue = "{.value}_{timepoint}",
        values_from = !c(newid, timepoint)
    )
    
    # calculate differences between baseline and year 2
    %>% mutate(
        .keep = 'unused',
        .after = newid,
        diff_agg_ment = agg_ment_2 - agg_ment_baseline,
        diff_agg_phys = agg_phys_2 - agg_phys_baseline,
        diff_leu3n = leu3n_2 - leu3n_baseline,
        diff_log_vload = log10(vload_2) - log10(vload_baseline),
        adherence = adh_2
    )
    %>% select(-matches('_2'), -adh_baseline)
    
    ## keep only participants with all outcomes at 0 and 2 years
    %>% filter(!if_any(matches('diff'), is.na))
) -> hiv_clean
```

```{r}
hiv_clean
```


```{r}
hiv_clean %>%
  # Pivot the difference columns longer so we can plot them all at once
  pivot_longer(cols = starts_with("diff"), names_to = "outcome", values_to = "change") %>%
  
  ggplot(aes(x = hard_drugs_baseline, y = change, fill = hard_drugs_baseline)) +
  geom_boxplot(na.rm = TRUE) +
  facet_wrap(~outcome, scales = "free_y") +
  theme_minimal() +
  labs(title = "Treatment Response (Year 0 to 2) by Baseline Hard Drug Use",
       y = "Change from Baseline")
```


```{r}
(
    hiv_clean
    %>% select(matches("diff"), hard_drugs_baseline)
    %>% mutate(missing = if_any(everything(), is.na))
    %>% summarise(
        .by = hard_drugs_baseline,
        missing = mean(missing),
        n()
    )
)
```



```{r}
get_formula <- \(outcome) paste0(outcome, " ~
                            hard_drugs_baseline + age_baseline + bmi_baseline + smoke_baseline + educbas_baseline + race_baseline")

# frequentist models
agg_ment_mod_freq <- lm(get_formula("diff_leu3n"), data = hiv_clean)
summary(agg_ment_mod_freq)
```

```{r}
plot(agg_ment_mod_freq)
```


```{r}
hist(hiv_clean$diff_leu3n)
```

# Project 1
## Joe Nagel

# Introduction

HIV (human immunodeficiency virus) is a virus that attacks the immune system; it destroys T-cells and inhibits your body's ability to fight infection. This analysis evaluates the effectiveness of highly active antiretroviral treatment (HAART), the standard treatment for HIV patients. The data come from the Multicenter AIDS Cohort Study, an ongoing study investigating HIV infection in homosexual and bisexual men in the United States. The dataset includes longitudinal demographic information, laboratory measurements, and quality of life measurements on men infected with HIV. Data was collected on subjects at the begining of HAART treatment (baseline) and every year thereafter for up to 8 years. The primary goal of this analysis is to charaterize how treatment response after 2 years of treatment differs based on a subjects hard drug use status at baseline. Specifically, we will investigate the difference in aggregate physical quality of life score, aggregate mental quality of life score, HIV viral load, and CD4+ T cell count between baseline and two years across hard drug use status at baseline while adjusting for age, bmi, smoking status, education, and race. We will compare Bayesian and non-Bayesian analysis approaches.

# Preliminary Methods

We will begin by checking the analysis variables for missingness and outliers; we will specifically check if missingness differs between hard drug users and non-hard drug uses. We will calculate the change in outcomes as the value at Year 2 minus the value at Year 0. We will also visualize the distributions of the four outcome difference scores using histograms and boxplots to identify potential outliers and assess the need for any transformations prior to analysis. For the primary analysis, we will generate descriptive statistics to compare baseline demographic and clinical characteristics between those who reported hard drug use and those who did not. To evaluate the effect of baseline hard drug use on treatment response, we will fit four separate multivariable linear regression modelsâ€”one for each outcome (change in aggregate physical score, aggregate mental score, CD4+ count, and viral load). The primary predictor of interest will be baseline hard drug use status. All models will adjust for the specified demographic variables: age, BMI, smoking status, education, and race. We will approach modeling from both a Bayesian and non-Bayesian approach. For the non-Bayesian, we will use standard Ordinary Least Squares (OLS) regression, reporting point estimates, 95% confidence intervals, and p-values. For the Bayesian, we will fit Bayesian linear regression models. We will specify non-informative or weakly informative prior distributions for our parameters and estimate posterior distributions using Markov Chain Monte Carlo (MCMC) methods. We will report posterior means, 95% Highest Posterior Density (HPD) credible intervals, and posterior probabilities to evaluate the primary research question. We will compare the results from both frameworks and determine if there are any differences in the interpretations. Finally, we will investigate if any relationship between hard drug use and the outcomes is explained by adherence to the treatment protocol.