---
title: "Project1"
author: "Joe Nagel"
date: ""
output: 
  pdf_document:
    number_sections: true
fontsize: 12pt
mainfont: Helvetica
geometry: margin=1in
header-includes:
  - \usepackage{float}
  - \usepackage{setspace}
  - \doublespacing
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(list(echo = FALSE, include = FALSE))
```

```{r}
# read in packages
source("functions.R")
library(tidyverse)
library(naniar)
library(janitor)
library(lme4)
library(lmerTest)
library(emmeans)
library(gtsummary)
library(gt)
library(knitr)
library(kableExtra)
library(patchwork) 
library(broom.mixed)
library(brms)
library(loo)
library(posterior)
library(bayestestR)
```

```{r}
(
    read_csv('../Data/hiv_6624_final.csv', show_col_types = FALSE, name_repair = "unique_quiet")
    %>% clean_names()
) -> hiv
```

```{r}
# read in data
(
    hiv
    # remove bad bmi values
    %>% mutate(
        log_vload = log10(vload),
        agg_ment = if_else(agg_ment < 0, NA_real_, agg_ment),
        bmi = if_else(bmi < 0 | 400 <= bmi, NA_real_, bmi),
        timepoint = if_else(years == 0, 'baseline', as.character(years)),
        adh = recode_values(
            adh,
            1:2 ~ ">=95%",
            3:4 ~ "<95%",
            NA ~ NA_character_,
            default = "Not Handled"
        ) %>% factor(levels = c(">=95%", "<95%")),
        hard_drugs = recode_values(
            hard_drugs,
            0 ~ "No Hard Drug Use",
            1 ~ "Hard Drug Use",
            NA ~ NA_character_,
            default = "Not Handled"
        ) %>% factor(levels = c("No Hard Drug Use", "Hard Drug Use")),
        smoke = recode_values(
            smoke,
            1:2 ~ "Never/Former Smoker",
            3 ~ "Current Smoker",
            NA ~ NA_character_,
            default = "Not Handled"
        ) %>% factor(levels = c("Never/Former Smoker", "Current Smoker")),
        race_recode = recode_values(
            race,
            1 ~ "Non-Hispanic White",
            2:8 ~ "Other",
            NA ~ NA_character_,
            default = "Not Handled"
        ) %>% factor(levels = c("Non-Hispanic White", "Other")),
        edu_recode = recode_values(
            educbas,
            1:4 ~ "No College Degree",
            5:7 ~ "College Degree or Greater",
            NA ~ NA_character_,
            default = "Not Handled"
        ) %>% factor(levels = c("No College Degree", "College Degree or Greater"))
    )
    
    # hiv positive only
    %>% filter(hivpos == 1)
    
    # filter to baseline and year 2
    %>% filter(years %in% c(0, 2))
    %>% select(
        newid, timepoint, agg_ment, agg_phys, leu3n, log_vload,
        hard_drugs, adh, age, bmi, smoke, edu_recode, race_recode
    )
    %>% pivot_wider(
        id_cols = newid,
        names_from = timepoint,
        names_glue = "{.value}_{timepoint}",
        values_from = !c(newid, timepoint)
    )
    
    # calculate differences between baseline and year 2
    %>% mutate(
        # .keep = 'unused',
        .after = newid,
        diff_agg_ment = agg_ment_2 - agg_ment_baseline,
        diff_agg_phys = agg_phys_2 - agg_phys_baseline,
        diff_leu3n = leu3n_2 - leu3n_baseline,
        diff_log_vload = log_vload_2 - log_vload_baseline,
        adh = adh_2
    )
    %>% select(-matches('_2'), -adh_baseline)
) -> hiv_clean
```

```{r}
hiv_analysis <- hiv_clean %>% filter(!if_any(matches('diff'), is.na))
```

```{r, eval = FALSE}
hist(hiv_analysis$diff_agg_ment)
hist(hiv_analysis$diff_agg_phys)
hist(hiv_analysis$diff_log_vload)
hist(hiv_analysis$diff_leu3n)
```

```{r}
(
    hiv_clean
    %>% summarise(
        .by = hard_drugs_baseline,
        n_missing = sum(if_any(matches("diff"), is.na)),
        total = n(),
        prop = mean(if_any(matches("diff"), is.na))
    )
)
```

```{r}
hiv_clean %>% filter(if_any(matches('diff'), is.na))
```


```{r}
# create table 1
table1 <- (
    hiv_analysis
    %>% tbl_summary(
        by = hard_drugs_baseline,
        statistic = list(
            all_continuous() ~ "{mean} ({sd})",
            all_categorical() ~ "{n} ({p}%)"
        ),
        missing = "ifany",
        missing_text = "Missing/Improbable, n (%)",
        missing_stat = "{N_miss} ({p_miss}%)",
        label = list(                              
            agg_ment_baseline    ~ "SF-36 MCS, mean (SD)",
            agg_phys_baseline    ~ "SF-36 PCS, mean (SD)",
            leu3n_baseline       ~ "CD4+ T Cell Count, mean (SD)",
            log_vload_baseline   ~ "Log Viral Load, mean (SD)",
            adh                  ~ "Adherence, n (%)",
            age_baseline         ~ "Age (Years), mean (SD)",
            bmi_baseline         ~ "BMI, mean (SD)",
            smoke_baseline       ~ "Smoking Status, n (%)",
            edu_recode_baseline  ~ "Education, n (%)",
            race_recode_baseline ~ "Race/Ethnicity, n (%)"
        ),
        include = c(
            agg_ment_baseline,
            agg_phys_baseline,
            leu3n_baseline,
            log_vload_baseline,
            age_baseline,
            bmi_baseline,
            adh,
            smoke_baseline,
            edu_recode_baseline,
            race_recode_baseline
        ),
        digits = list(
            all_continuous() ~ 1
            # all_categorical() ~ 1
        )
    )
    %>% add_overall(last = TRUE)
    %>% modify_footnote(everything() ~ NA)
    %>% as_kable_extra(
        
        booktabs = TRUE,
        linesep = "",
        caption = "Descriptive Statistics of Baseline Covariates and Year 2 Adherence",
        escape = TRUE
    )
    %>% kable_styling(latex_options = c("scale_down", "HOLD_position"))
)
```

```{r, include = TRUE}
table1
```

```{r}
# model formulas
formula_ment <- diff_agg_ment ~
    hard_drugs_baseline + agg_ment_baseline + age_baseline +
    bmi_baseline + smoke_baseline + edu_recode_baseline + race_recode_baseline

formula_phys <- diff_agg_phys ~
    hard_drugs_baseline + agg_phys_baseline + age_baseline +
    bmi_baseline + smoke_baseline + edu_recode_baseline + race_recode_baseline

formula_vload <- diff_log_vload ~
    hard_drugs_baseline + log_vload_baseline + age_baseline +
    bmi_baseline + smoke_baseline + edu_recode_baseline + race_recode_baseline

formula_leu3n <- diff_leu3n ~
    hard_drugs_baseline + leu3n_baseline + age_baseline +
    bmi_baseline + smoke_baseline + edu_recode_baseline + race_recode_baseline
```

```{r}
# frequentist models
fmod_ment <- lm(formula_ment, data = hiv_analysis)
fmod_phys <- lm(formula_phys, data = hiv_analysis)
fmod_vload <- lm(formula_vload, data = hiv_analysis)
fmod_leu3n <- lm(formula_leu3n, data = hiv_analysis)
```

```{r}
# frequentist models with adherence
fmod_ment_adh <- lm(update(formula_ment, . ~ . + adh), data = hiv_analysis)
fmod_phys_adh <- lm(update(formula_phys, . ~ . + adh), data = hiv_analysis)
fmod_vload_adh <- lm(update(formula_vload, . ~ . + adh), data = hiv_analysis)
fmod_leu3n_adh <- lm(update(formula_leu3n, . ~ . + adh), data = hiv_analysis)
```

```{r}
# fit Bayesian models
bmod_ment <- fit_brm(formula = formula_ment, data = hiv_analysis, file = "../Models/bmod_ment")
bmod_phys <- fit_brm(formula = formula_phys, data = hiv_analysis, file = "../Models/bmod_phys")
bmod_vload <- fit_brm(formula = formula_vload, data = hiv_analysis, file = "../Models/bmod_vload")
bmod_leu3n <- fit_brm(formula = formula_leu3n, data = hiv_analysis, file = "../Models/bmod_leu3n")
```

```{r}
# fit Bayesian models without hard drug term
bmod_ment_red <- fit_brm(
    formula = update(formula_ment, . ~ . - hard_drugs_baseline),
    data = hiv_analysis,
    file = "../Models/bmod_ment_red"
)
bmod_phys_red <- fit_brm(
    formula = update(formula_phys, . ~ . - hard_drugs_baseline),
    data = hiv_analysis,
    file = "../Models/bmod_phys_red"
)
bmod_vload_red <- fit_brm(
    formula = update(formula_vload, . ~ . - hard_drugs_baseline),
    data = hiv_analysis,
    file = "../Models/bmod_vload_red"
)
bmod_leu3n_red <- fit_brm(
    formula = update(formula_leu3n, . ~ . - hard_drugs_baseline),
    data = hiv_analysis,
    file = "../Models/bmod_leu3n_red"
)
```

```{r}
# fit Bayesian models with adherence term
bmod_ment_adh <- fit_brm(
    formula = update(formula_ment, . ~ . + adh),
    data = hiv_analysis,
    file = "../Models/bmod_ment_adh"
)
bmod_phys_adh <- fit_brm(
    formula = update(formula_phys, . ~ . + adh),
    data = hiv_analysis,
    file = "../Models/bmod_phys_adh"
)
bmod_vload_adh <- fit_brm(
    formula = update(formula_vload, . ~ . + adh),
    data = hiv_analysis,
    file = "../Models/bmod_vload_adh"
)
bmod_leu3n_adh <- fit_brm(
    formula = update(formula_leu3n, . ~ . + adh),
    data = hiv_analysis,
    file = "../Models/bmod_leu3n_adh"
)
```

```{r}
# Named list to iterate across outcomes (for labeling rows)
row_labels <- c(
  "SF-36 MCS"   = "diff_agg_ment",
  "SF-36 PCS" = "diff_agg_phys",
  "CD4+ Count"  = "diff_leu3n",
  "Log Viral Load"     = "diff_log_vload"
)

# Clinical thresholds matching the order of row_labels
clinical_thresholds <- c(2, 2, 50, 0.5)

# Collect models in parallel lists (order must match row_labels)
fmods      <- list(fmod_ment, fmod_phys, fmod_leu3n, fmod_vload)  
bmods_full <- list(bmod_ment, bmod_phys, bmod_leu3n, bmod_vload)
bmods_red  <- list(bmod_ment_red, bmod_phys_red, bmod_leu3n_red, bmod_vload_red)

table_freq_bayes <- (
  pmap_dfr(
    list(names(row_labels), fmods, bmods_full, bmods_red, clinical_thresholds),
    function(outcome_label, ffit, bfit_full, bfit_red, thresh) {
      
      # Frequentist
      fr    <- extract_lm_stats(ffit, "hard_drugs_baseline")
      fr_ci <- sprintf("[%s, %s]", fmt(fr$lcl), fmt(fr$ucl))
      p_str <- if (fr$p < 0.001) "<0.001" else fmt(fr$p, digits = 3)

      # Bayesian with HDI and clinical threshold
      br    <- extract_brm_stats_hdi(bfit_full, "hard_drugs_baseline", cred = 0.95, threshold = thresh)
      br_ci <- sprintf("[%s, %s]", fmt(br$lcl), fmt(br$ucl))
      p_clin_str <- fmt(br$p_clin, digits = 3)

      # Î”LOOIC using prefit reduced model
      dL <- delta_loo_prefit(bfit_full, bfit_red, reloo = FALSE)

      tibble::tibble(
        Outcome                  = outcome_label,
        `Frequentist Estimate`   = as.numeric(fr$estimate),
        `Frequentist 95% CI`     = fr_ci,
        `p-value`                = p_str,
        `Bayesian Estimate`      = as.numeric(br$estimate),
        `Bayesian 95% HDI`       = br_ci,
        `P(|Effect| > Threshold)`= p_clin_str,
        `delta LOOIC`            = as.numeric(dL$delta_looic)
      )
    }
  ) %>%
  mutate(
    `Frequentist Estimate` = as.numeric(fmt(`Frequentist Estimate`)),
    `Bayesian Estimate`    = as.numeric(fmt(`Bayesian Estimate`)),
    `delta LOOIC`          = as.numeric(fmt(`delta LOOIC`, digits = 2))
  ) %>%
  kable(
    format = "latex",
    booktabs = TRUE,
    linesep  = "",
    caption  = "Frequentist and Bayesian Estimates for the Hard Drug Use Effect",
    align    = "lcccccccc", # Added one 'c' for the new column
    escape   = FALSE,
    col.names = c("Outcome", "Estimate", "95\\% CI", "p-value",
                  "Estimate", "95\\% HDI", "$P(|\\beta| > \\text{Threshold})$", "$\\Delta$ LOO-IC")
  ) %>%
  add_header_above(
    c(" " = 1, "Frequentist" = 3, "Bayesian" = 4), # Bayesian span goes from 3 to 4
    bold = TRUE
  ) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position"))
)
```

```{r, include=TRUE}
table_freq_bayes
```
```{r}
# Collect models in parallel lists matching the outcomes
bmods_base <- list(bmod_ment, bmod_phys, bmod_leu3n, bmod_vload)
bmods_adh  <- list(bmod_ment_adh, bmod_phys_adh, bmod_leu3n_adh, bmod_vload_adh)

row_labels <- c(
  "SF-36 MCS",
  "SF-36 PCS",
  "CD4+ T Cell Count",
  "Log Viral Load"
)

table_adh_comparison_bayes <- pmap_dfr(
  list(row_labels, bmods_base, bmods_adh),
  function(outcome_label, fit_base, fit_adh) {
    
    # 1. Unadjusted Hard drugs effect (Base model without adherence)
    res_no_adh <- extract_brm_stats_hdi(fit_base, "hard_drugs_baseline")
    
    # 2. Adjusted Hard drugs effect (Model with adherence)
    res_adh <- extract_brm_stats_hdi(fit_adh, "hard_drugs_baseline")
    
    # 3. Adherence effect (Model with adherence)
    res_adh_term <- extract_brm_stats_hdi(fit_adh, "adh")
    
    # 4. Delta LOOIC
    dL <- delta_loo_prefit(full_fit = fit_adh, reduced_fit = fit_base, reloo = FALSE)
    
    tibble::tibble(
      Outcome = outcome_label,
      `Unadj_Est` = fmt(res_no_adh$estimate, 2),
      `Unadj_HDI` = sprintf("[%s, %s]", fmt(res_no_adh$lcl, 2), fmt(res_no_adh$ucl, 2)), 
      `Adj_Est` = fmt(res_adh$estimate, 2),
      `Adj_HDI` = sprintf("[%s, %s]", fmt(res_adh$lcl, 2), fmt(res_adh$ucl, 2)), 
      `adh_est` = fmt(res_adh_term$estimate, 2),
      `adh_HDI  ` = sprintf("[%s, %s]", fmt(res_adh_term$lcl, 2), fmt(res_adh_term$ucl, 2)),
      `delta_loo` = fmt(dL$delta_looic, 1)
    )
  }
) %>%
  kable(
    format = "latex",
    booktabs = TRUE,
    linesep = "",
    caption = "Bayesian Estimates: Impact of Adjusting for Adherence on the Effect of Baseline Hard Drug Use (HDU)",
    escape = FALSE,
    align = "lccccccc", # Updated to exactly match 8 columns
    col.names = c(
      "Outcome", 
      "Estimate", 
      "95\\% HDI", 
      "Estimate", 
      "95\\% HDI", 
      "Estimate", 
      "95\\% HDI", 
      "$\\Delta$ LOO-IC"
    )
  ) %>%
  add_header_above(
    c(
        " " = 1,
        "Unadjusted HDU Effect" = 2, 
        "Adjusted HDU Effect" = 2, 
        "Adherence Effect" = 3
    ), 
    bold = TRUE
  ) %>% 
  kable_styling(latex_options = c("scale_down", "HOLD_position"))
```


```{r, include = TRUE}
table_adh_comparison_bayes
```

```{r}
# Collect frequentist models in parallel lists matching the outcomes
fmods_base <- list(fmod_ment, fmod_phys, fmod_leu3n, fmod_vload)
fmods_adh  <- list(fmod_ment_adh, fmod_phys_adh, fmod_leu3n_adh, fmod_vload_adh)

row_labels <- c(
  "SF-36 MCS",
  "SF-36 PCS",
  "CD4+ T Cell Count",
  "Log Viral Load"
)

table_adh_comparison_freq <- pmap_dfr(
  list(row_labels, fmods_base, fmods_adh),
  function(outcome_label, fit_base, fit_adh) {
    
    # 1. Unadjusted Hard drugs effect (Base model)
    res_no_adh <- extract_lm_stats(fit_base, "hard_drugs_baseline")
    
    # 2. Adjusted Hard drugs effect (Model with adherence)
    res_adh <- extract_lm_stats(fit_adh, "hard_drugs_baseline")
    
    # 3. Adherence effect (Model with adherence)
    res_adh_term <- extract_lm_stats(fit_adh, "adh")
    
    # 4. Format p-value for the adherence estimate
    p_str <- if (res_adh_term$p < 0.001) "<0.001" else fmt(res_adh_term$p, digits = 3)
    
    tibble::tibble(
      Outcome = outcome_label,
      `Unadj_Est` = fmt(res_no_adh$estimate, 2),
      `Unadj_CI` = sprintf("[%s, %s]", fmt(res_no_adh$lcl, 2), fmt(res_no_adh$ucl, 2)), 
      `Adj_Est` = fmt(res_adh$estimate, 2),
      `Adj_CI` = sprintf("[%s, %s]", fmt(res_adh$lcl, 2), fmt(res_adh$ucl, 2)), 
      `adh_est` = fmt(res_adh_term$estimate, 2),
      `adh_CI  ` = sprintf("[%s, %s]", fmt(res_adh_term$lcl, 2), fmt(res_adh_term$ucl, 2)),
      `p_value` = p_str
    )
  }
) %>%
  kable(
    format = "latex",
    booktabs = TRUE,
    linesep = "",
    caption = "Frequentist Estimates: Impact of Adjusting for Adherence on the Effect of Baseline Hard Drug Use (HDU)",
    escape = FALSE,
    align = "lcccccccc", # 8 columns total
    col.names = c(
      "Outcome", 
      "Estimate", 
      "95\\% CI", 
      "Estimate", 
      "95\\% CI", 
      "Estimate", 
      "95\\% CI", 
      "p-value"
    )
  ) %>%
  add_header_above(
    c(
        " " = 1,
        "Unadjusted HDU Effect" = 2, 
        "Adjusted HDU Effect" = 2, 
        "Adherence Effect" = 3
    ), 
    bold = TRUE
  ) %>% 
  kable_styling(latex_options = c("scale_down", "HOLD_position"))
```

```{r, include = TRUE}
table_adh_comparison_freq
```




```{r, eval=FALSE}
# diagnostics for Bayesian models
bmods <- list(bmod_ment, bmod_phys, bmod_leu3n, bmod_vload,
              bmod_ment_red, bmod_phys_red, bmod_leu3n_red, bmod_vload_red,
              bmod_ment_adh, bmod_phys_adh, bmod_leu3n_adh, bmod_vload_adh)

bmod <- bmod_vload_adh
summary(bmod) # check R-hat (~1) and ESS (>1000)
mcmc_plot(bmod, type = "dens_overlay") # all chains should match
mcmc_plot(bmod, type = "trace") # check for good mixing
mcmc_plot(bmod, type = "acf") # check for lower autocorrelation
```


```{r}
hiv_analysis %>%
  pivot_longer(cols = starts_with("diff"), names_to = "outcome", values_to = "change") %>%
  ggplot(aes(x = hard_drugs_baseline, y = change, fill = hard_drugs_baseline)) +
  geom_boxplot(na.rm = TRUE) +
  facet_wrap(~outcome, scales = "free_y") +
  theme_minimal() +
  labs(title = "Treatment Response (Year 0 to 2) by Baseline Hard Drug Use",
       y = "Change from Baseline")
```


# Introduction

HIV (human immunodeficiency virus) is a virus that attacks the immune system; it destroys T-cells and inhibits the body's ability to fight infection. This analysis evaluates the effectiveness of highly active antiretroviral treatment (HAART), the standard treatment for HIV patients. The data come from the Multicenter AIDS Cohort Study, an ongoing study investigating HIV infection in homosexual and bisexual men in the United States. The dataset includes longitudinal demographic information, laboratory measurements, and 36-Item Short Form Health Survey (SF-36) quality of life summaries on men infected with HIV. Data was collected on subjects at the beginning of HAART treatment (baseline) and every year thereafter for up to 8 years. The primary goal of this analysis is to characterize how treatment response after 2 years of treatment differs based on a subjects hard drug use status at baseline. Specifically, we will investigate the difference in SF-36 Mental Component Summary (MCS) score, SF-36 Physical Component Summary (PCS) score, HIV viral load, and CD4+ T cell count (CD4+ count) between baseline and two years across hard drug use status at baseline while adjusting for baseline measurements, age, bmi, smoking status, education, and race. Additionally, we will investigate if any effects of hard drug use depend on study protocol adherence.

# Methods

## Data Management

This analysis only considered subjects with the four primary measures---PCS, MCS, CD4+ count, and viral load---measured before starting HAART treatment (baseline) and after two years of treatment (year 2).  Consistent with standard practice in the literature, viral load was analyzed on the $\log_{10}$ scale, where a one-unit increase corresponds to a 10-fold (order of magnitude) increase in viral load. We investigated if missingness in the primary measures differed between hard drug users and non hard drug users. Due to low sample sizes within specific strata, the categories of several demographic variables were combined: race/ethnicity was combined into non-Hispanic White and other, education was combined into no college degree and college degree or greater, and smoking was combined into current smokers and never/former smokers. Study protocol adherence at year 2 was dichotomized as $\ge95\%$ and $<95\%$. Additionally, biologically improbable BMI measurements (BMI $<0$ or $>400$) were excluded from the analysis. Finally, for each primary measure, the difference between measurements at baseline and year 2 was calculated and assess for normality and outliers. A table of descriptive statistics was created for the demographic variables used in the analysis as well as the primary measures at baseline.

## Analysis Approach

For each primary measure, the outcome was defined as the difference between the baseline and year 2 measurements. Prior to analysis, each outcome was visualized across hard drug uses status using histograms. Regression models were fit for each outcome using both frequentist and Bayesian approaches; all models adjusted for the subjects baseline measurement, bmi, age, race, education level, and smoking status.

## Bayesian Modeling and Diagnositics.

For all Bayesian models, the No-U-Turn Sampler (NUTS) was used with 4 chains. Parameters were initialized using random values sampled from a $\operatorname{Unif}(-2, 2)$ distribution on the unconstrained parameter space. Each chain ran for 1000 warmup iterations and 2000 total iterations. The Bayesian models employed normally distributed likelihoods and non-informative priors: intercepts and fixed effects had $\operatorname{Normal}(0, 100)$ priors, and the residual standard errors had $\operatorname{Half-Normal}(0, 100)$ priors.

The same diagnostic procedure was followed for all of the Bayesian models. First, we ensured the effective sample size (ESS) was sufficient for all parameters (> 1000) and that the R-hat (Gelman-Rubin statistic) was close to 1, indicating convergence. Convergence was further assessed by plotting each parameter's density and comparing between chains. Additionally, trace and autocorrelation plots were visually inspected to evaluate chain mixing and sample dependency.

# Results

Table 1 shows summary statistics for the demographic variables and primary measures at baseline. Missingness in the primary measures was higher for the hard drug use group (41%) than the non-hard drug use group (33%), indicating that missingness may depend on hard drug use status. 

all models had effective sample sizes well over 1000 and no evidence of issues with autocorrelation. convergence was assessed with trace plots and chain density overlays for each parameter. 

there was no evidence of issues with convergence in any of the bayesian models with all rhats near 1.

# Discussion

Potential Limitation of this work: it could be that hard drug users have better adherence because the ones that dont have good adherence did not have measurements at year 2